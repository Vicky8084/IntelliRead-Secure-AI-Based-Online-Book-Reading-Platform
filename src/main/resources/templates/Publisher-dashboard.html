<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Dashboard | Intelli-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Chakra Petch', sans-serif;
          background-color: #f5f7fa;
          color: #333;
          line-height: 1.6;
        }

        .admin-header {
          background: linear-gradient(135deg, #4a90e2, #5a6ae4);
          color: white;
          padding: 15px 0;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 20px;
        }

        .header-left h1 {
          font-size: 1.8rem;
          font-weight: 700;
        }

        .admin-info {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .logout-btn {
          background: rgba(255,255,255,0.2);
          color: white;
          border: 1px solid rgba(255,255,255,0.3);
          padding: 8px 15px;
          border-radius: 5px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 5px;
          transition: all 0.3s ease;
        }

        .logout-btn:hover {
          background: rgba(255,255,255,0.3);
        }

        .admin-container {
          display: flex;
          max-width: 1200px;
          margin: 0 auto;
          min-height: calc(100vh - 70px);
        }

        .sidebar {
          width: 250px;
          background: white;
          padding: 20px 0;
          box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-header {
          padding: 0 20px 20px;
          border-bottom: 1px solid #eee;
        }

        .sidebar-header h2 {
          font-size: 1.3rem;
          color: #4a90e2;
        }

        .sidebar-menu {
          list-style: none;
          margin-top: 20px;
        }

        .menu-item {
          padding: 12px 20px;
          display: flex;
          align-items: center;
          gap: 10px;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .menu-item:hover {
          background: #f0f5ff;
        }

        .menu-item.active {
          background: #e6f0ff;
          border-right: 3px solid #4a90e2;
          color: #4a90e2;
        }

        .main-content {
          flex: 1;
          padding: 30px;
          background: #f5f7fa;
        }

        .section {
          display: none;
        }

        .section.active {
          display: block;
        }

        .section-header {
          margin-bottom: 30px;
        }

        .section-header h1 {
          font-size: 1.8rem;
          margin-bottom: 5px;
          color: #333;
        }

        .section-header p {
          color: #666;
        }

        .header-actions {
          display: flex;
          gap: 15px;
          margin-top: 15px;
        }

        .publisher-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .stat-card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .stat-card.primary {
          border-left: 4px solid #4a90e2;
        }

        .stat-card.success {
          border-left: 4px solid #28a745;
        }

        .stat-card.warning {
          border-left: 4px solid #ffc107;
        }

        .stat-card.info {
          border-left: 4px solid #17a2b8;
        }

        .stat-card.danger {
          border-left: 4px solid #dc3545;
        }

        .stat-icon {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
        }

        .stat-card.primary .stat-icon {
          background: #e6f0ff;
          color: #4a90e2;
        }

        .stat-card.success .stat-icon {
          background: #e8f5e8;
          color: #28a745;
        }

        .stat-card.warning .stat-icon {
          background: #fff8e1;
          color: #ffc107;
        }

        .stat-card.info .stat-icon {
          background: #e1f5fe;
          color: #17a2b8;
        }

        .stat-card.danger .stat-icon {
          background: #ffe6e6;
          color: #dc3545;
        }

        .stat-info h3 {
          font-size: 1.8rem;
          margin-bottom: 5px;
        }

        .stat-info p {
          color: #666;
          font-size: 0.9rem;
        }

        .activity-section {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .activity-section h3 {
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
        }

        .activity-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 0;
          border-bottom: 1px solid #f5f5f5;
        }

        .activity-info h4 {
          font-size: 1rem;
          margin-bottom: 5px;
        }

        .activity-time {
          color: #888;
          font-size: 0.85rem;
        }

        .search-box {
          position: relative;
          flex: 1;
        }

        .search-box i {
          position: absolute;
          left: 10px;
          top: 50%;
          transform: translateY(-50%);
          color: #888;
        }

        .search-box input {
          width: 100%;
          padding: 10px 10px 10px 35px;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: 'Chakra Petch', sans-serif;
        }

        select {
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: 'Chakra Petch', sans-serif;
          background: white;
        }

        .table-container {
          background: white;
          border-radius: 10px;
          overflow: hidden;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
          margin-bottom: 20px;
          overflow-x: auto;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          min-width: 800px;
        }

        th, td {
          padding: 15px;
          text-align: left;
          border-bottom: 1px solid #eee;
        }

        th {
          background: #f8f9fa;
          font-weight: 600;
          color: #555;
        }

        .upload-area {
          border: 2px dashed #ddd;
          border-radius: 10px;
          padding: 40px;
          text-align: center;
          margin: 20px 0;
          transition: all 0.3s ease;
          cursor: pointer;
          background: white;
        }

        .upload-area:hover {
          border-color: #4a90e2;
          background-color: #f8f9fa;
        }

        .upload-area i {
          font-size: 48px;
          color: #6c757d;
          margin-bottom: 15px;
        }

        .book-cover-preview {
          max-width: 150px;
          max-height: 200px;
          border-radius: 5px;
          margin: 10px auto;
          display: block;
        }

        .form-row {
          display: flex;
          gap: 20px;
          margin-bottom: 20px;
        }

        .form-group {
          flex: 1;
        }

        .form-group label {
          display: block;
          margin-bottom: 8px;
          font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: 'Chakra Petch', sans-serif;
        }

        .form-group textarea {
          min-height: 100px;
          resize: vertical;
        }

        .book-actions {
          display: flex;
          gap: 10px;
        }

        .btn-sm {
          padding: 6px 12px;
          font-size: 0.85rem;
        }

        .status-badge {
          padding: 4px 10px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 500;
        }

        .status-published {
          background-color: #d1edff;
          color: #0c5460;
        }

        .status-draft {
          background-color: #fff3cd;
          color: #856404;
        }

        .book-cover-cell {
          width: 60px;
        }

        .book-cover-cell img {
          width: 50px;
          height: 65px;
          object-fit: cover;
          border-radius: 4px;
        }

        .action-buttons {
          display: flex;
          gap: 10px;
          justify-content: flex-end;
          margin-top: 20px;
        }

        .btn-primary {
          background: #4a90e2;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          font-family: 'Chakra Petch', sans-serif;
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .btn-primary:hover {
          background: #3a80d2;
        }

        .btn-secondary {
          background: #6c757d;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          font-family: 'Chakra Petch', sans-serif;
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .btn-secondary:hover {
          background: #5a6268;
        }

        .btn-danger {
          background: #dc3545;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          font-family: 'Chakra Petch', sans-serif;
          font-weight: 500;
          transition: all 0.3s ease;
        }

        .btn-danger:hover {
          background: #c82333;
        }

        .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
          background-color: #fff;
          margin: 5% auto;
          padding: 30px;
          border-radius: 10px;
          width: 80%;
          max-width: 700px;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
        }

        .modal-content.large {
          max-width: 800px;
        }

        .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          position: absolute;
          right: 20px;
          top: 15px;
        }

        .close:hover {
          color: #000;
        }

        .book-detail-view {
          display: flex;
          gap: 30px;
        }

        .book-cover-large img {
          width: 200px;
          height: 280px;
          object-fit: cover;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .book-info {
          flex: 1;
        }

        .book-info h3 {
          font-size: 1.5rem;
          margin-bottom: 15px;
        }

        .book-info p {
          margin-bottom: 10px;
        }

        .analytics-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
        }

        .chart-card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .chart-card h3 {
          margin-bottom: 15px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
        }

        .chart-placeholder {
          height: 250px;
          background: #f8f9fa;
          border-radius: 5px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #6c757d;
        }

        .settings-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .setting-card {
          background: white;
          border-radius: 10px;
          padding: 20px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .setting-card h3 {
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
        }

        .setting-item {
          margin-bottom: 15px;
        }

        .setting-item label {
          display: block;
          margin-bottom: 5px;
          font-weight: 500;
        }

        .setting-item input,
        .setting-item textarea {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          font-family: 'Chakra Petch', sans-serif;
        }

        .setting-item textarea {
          min-height: 80px;
          resize: vertical;
        }

        .pagination {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 20px;
        }

        .pagination button {
          padding: 8px 12px;
          border: 1px solid #ddd;
          background: white;
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .pagination button.active {
          background: #4a90e2;
          color: white;
          border-color: #4a90e2;
        }

        .pagination button:hover:not(.active) {
          background: #f5f5f5;
        }

        .loading-spinner {
          display: none;
          width: 20px;
          height: 20px;
          border: 2px solid #f3f3f3;
          border-top: 2px solid #4a90e2;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        .toast {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: bold;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          max-width: 300px;
          text-align: center;
          display: none;
          animation: slideIn 0.3s ease-out;
        }

        .toast.success {
          background-color: #28a745;
        }

        .toast.error {
          background-color: #dc3545;
        }

        @keyframes slideIn {
          from {
              transform: translateX(100%);
              opacity: 0;
          }
          to {
              transform: translateX(0);
              opacity: 1;
          }
        }

        /* Category specific styles */
        .category-badge {
          padding: 4px 8px;
          background: #e9ecef;
          border-radius: 12px;
          font-size: 0.75rem;
          color: #495057;
        }

        .category-filters {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
        }

        .category-filter-btn {
          padding: 8px 16px;
          border: 1px solid #ddd;
          background: white;
          border-radius: 20px;
          cursor: pointer;
          transition: all 0.3s ease;
        }

        .category-filter-btn.active {
          background: #4a90e2;
          color: white;
          border-color: #4a90e2;
        }

        .category-filter-btn:hover {
          background: #f8f9fa;
        }

        /* Review specific styles */
        .reviews-summary {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
        }

        .average-rating {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .rating-stars-large {
          font-size: 24px;
          color: #ffc107;
        }

        .rating-details {
          display: flex;
          flex-direction: column;
        }

        .rating-details strong {
          font-size: 1.5rem;
          color: #333;
        }

        .review-count {
          color: #666;
          font-size: 0.9rem;
        }

        .no-reviews {
          text-align: center;
          padding: 30px;
          color: #666;
        }

        .review-item {
          background: white;
          transition: all 0.3s ease;
          border: 1px solid #eee;
          padding: 15px;
          margin: 10px 0;
          border-radius: 8px;
        }

        .review-item:hover {
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          transform: translateY(-2px);
        }

        .review-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        }

        .review-rating {
          color: #ffc107;
          font-size: 16px;
        }

        .review-date {
          color: #666;
          font-size: 0.9rem;
        }

        .review-text {
          color: #333;
          line-height: 1.5;
        }

        .rating-display {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .rating-value {
          color: #666;
          font-size: 0.9rem;
        }

        .review-count-badge {
          background: #4a90e2;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 0.75rem;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
          display: none;
          background: none;
          border: none;
          font-size: 24px;
          color: white;
          cursor: pointer;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
          .admin-container {
            flex-direction: column;
          }

          .sidebar {
            width: 100%;
            position: fixed;
            top: 70px;
            left: -100%;
            height: calc(100vh - 70px);
            z-index: 100;
            transition: left 0.3s ease;
            overflow-y: auto;
          }

          .sidebar.active {
            left: 0;
          }

          .main-content {
            padding: 20px;
            width: 100%;
          }

          .mobile-menu-btn {
            display: block;
          }

          .book-detail-view {
            flex-direction: column;
            gap: 20px;
          }

          .book-cover-large {
            align-self: center;
          }

          .modal-content {
            width: 90%;
            margin: 10% auto;
            padding: 20px;
          }

          .analytics-grid,
          .settings-grid {
            grid-template-columns: 1fr;
          }

          .chart-card,
          .setting-card {
            min-width: 0;
          }
        }

        @media (max-width: 768px) {
          .header-content {
            flex-direction: column;
            gap: 15px;
            text-align: center;
          }

          .admin-info {
            justify-content: center;
          }

          .header-actions {
            flex-direction: column;
          }

          .publisher-stats {
            grid-template-columns: 1fr;
          }

          .form-row {
            flex-direction: column;
            gap: 15px;
          }

          .action-buttons {
            flex-direction: column;
          }

          .book-actions {
            flex-direction: column;
            gap: 5px;
          }

          .category-filters {
            justify-content: center;
          }

          .table-container {
            border-radius: 5px;
          }

          table {
            font-size: 0.9rem;
          }

          th, td {
            padding: 10px 8px;
          }

          .average-rating {
            flex-direction: column;
            text-align: center;
            gap: 10px;
          }
        }

        @media (max-width: 480px) {
          .header-left h1 {
            font-size: 1.5rem;
          }

          .section-header h1 {
            font-size: 1.5rem;
          }

          .main-content {
            padding: 15px;
          }

          .stat-card {
            padding: 15px;
            flex-direction: column;
            text-align: center;
            gap: 10px;
          }

          .upload-area {
            padding: 20px;
          }

          .upload-area i {
            font-size: 36px;
          }

          .modal-content {
            width: 95%;
            padding: 15px;
          }

          .book-cover-large img {
            width: 150px;
            height: 210px;
          }
        }
    </style>
</head>
<body>
<!-- Toast notifications -->
<div id="toast" class="toast"></div>

<!-- Header -->
<header class="admin-header">
    <div class="header-content">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class='bx bx-menu'></i>
        </button>
        <div class="header-left">
            <h1>üìö Intelli-Read Publisher</h1>
        </div>
        <div class="header-right">
            <div class="admin-info">
                <span id="publisherName">Welcome, Publisher</span>
                <button class="logout-btn" onclick="logout()">
                    <i class='bx bx-log-out'></i> Logout
                </button>
            </div>
        </div>
    </div>
</header>

<div class="admin-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Publisher Panel</h2>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item active" onclick="showSection('dashboard')">
                <i class='bx bx-dashboard'></i>
                <span>Dashboard</span>
            </li>
            <li class="menu-item" onclick="showSection('myBooks')">
                <i class='bx bx-book'></i>
                <span>My Books</span>
            </li>
            <li class="menu-item" onclick="showSection('addBook')">
                <i class='bx bx-plus-circle'></i>
                <span>Add New Book</span>
            </li>
            <li class="menu-item" onclick="showSection('analytics')">
                <i class='bx bx-bar-chart'></i>
                <span>Book Analytics</span>
            </li>
            <li class="menu-item" onclick="showSection('profile')">
                <i class='bx bx-user'></i>
                <span>Profile</span>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <h1>Publisher Dashboard</h1>
                <p>Manage your books and track performance</p>
            </div>

            <!-- Stats Cards -->
            <div class="publisher-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalBooks">0</h3>
                        <p>Total Books</p>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class='bx bx-check-circle'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="publishedBooks">0</h3>
                        <p>Published Books</p>
                    </div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class='bx bx-time'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="draftBooks">0</h3>
                        <p>Draft Books</p>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class='bx bx-star'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalReviews">0</h3>
                        <p>Total Reviews</p>
                    </div>
                </div>

                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class='bx bx-trending-up'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="averageRating">0</h3>
                        <p>Avg. Rating</p>
                    </div>
                </div>
            </div>

            <!-- Recent Books -->
            <div class="activity-section">
                <div class="activity-card">
                    <h3>Recent Books</h3>
                    <div class="activity-list" id="recentBooks">
                        <!-- Recent books will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="activity-section" style="margin-top: 20px;">
                <div class="activity-card">
                    <h3>Category Distribution</h3>
                    <div id="categoryDistribution">
                        <!-- Category stats will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- My Books Section -->
        <section id="myBooks" class="section">
            <div class="section-header">
                <h1>My Books</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class='bx bx-search'></i>
                        <input type="text" id="bookSearch" placeholder="Search books..." onkeyup="searchBooks()">
                    </div>
                    <select id="statusFilter" onchange="filterBooks()">
                        <option value="">All Status</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                    </select>
                    <select id="categoryFilter" onchange="filterBooks()">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
            </div>

            <!-- Category Filters -->
            <div class="category-filters" id="quickCategoryFilters">
                <!-- Quick category filters will be loaded here -->
            </div>

            <div class="table-container">
                <table id="bookTable">
                    <thead>
                    <tr>
                        <th class="book-cover-cell">Cover</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Reviews</th>
                        <th>Rating</th>
                        <th>Language</th>
                        <th>Status</th>
                        <th>Date Added</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="bookTableBody">
                    <!-- Books will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="bookPagination">
                <!-- Pagination will be loaded here -->
            </div>
        </section>

        <!-- Add Book Section -->
        <section id="addBook" class="section">
            <div class="section-header">
                <h1>Add New Book</h1>
                <p>Upload and publish your books to Intelli-Read</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <i class='bx bx-cloud-upload'></i>
                <h3>Upload Book Cover</h3>
                <p>Drag & drop or click to upload book cover image</p>
                <input type="file" id="coverUpload" accept="image/*" style="display: none;">
                <img id="coverPreview" class="book-cover-preview" style="display: none;">
            </div>

            <form id="addBookForm">
                <input type="hidden" id="userId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="bookTitle">Book Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Author *</label>
                        <input type="text" id="bookAuthor" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bookCategory">Category *</label>
                        <select id="bookCategory" required>
                            <option value="">Select Category</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookLanguage">Language *</label>
                        <input type="text" id="bookLanguage" value="English" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bookDescription">Book Description</label>
                    <textarea id="bookDescription" placeholder="Enter book description..."></textarea>
                </div>

                <div class="form-group">
                    <label for="bookFile">Upload Book File (PDF/TXT) *</label>
                    <input type="file" id="bookFile" accept=".pdf,.txt" required>
                    <small>Only PDF and TXT files are allowed (max 10MB)</small>
                </div>

                <div class="action-buttons">
                    <button type="reset" class="btn-secondary">Clear Form</button>
                    <button type="submit" class="btn-primary">
                        <span class="loading-spinner" id="submitSpinner"></span>
                        Save Book
                    </button>
                </div>
            </form>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
            <div class="section-header">
                <h1>Book Analytics</h1>
                <p>Track your book performance and reader engagement</p>
            </div>

            <div class="analytics-grid">
                <div class="chart-card">
                    <h3>Category Performance</h3>
                    <div class="chart-placeholder" id="categoryPerformanceChart">
                        <p>Category-wise book performance</p>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Reader Engagement by Category</h3>
                    <div class="chart-placeholder" id="readerEngagementChart">
                        <p>Reader engagement metrics by category</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
            <div class="section-header">
                <h1>Publisher Profile</h1>
                <p>Manage your publisher account information</p>
            </div>

            <div class="settings-grid">
                <div class="setting-card">
                    <h3>Account Information</h3>
                    <div class="setting-item">
                        <label>Publisher Name</label>
                        <input type="text" id="publisherNameInput" value="Your Publisher Name">
                    </div>
                    <div class="setting-item">
                        <label>Contact Email</label>
                        <input type="email" id="publisherEmail" value="publisher@example.com">
                    </div>
                    <div class="setting-item">
                        <label>Phone Number</label>
                        <input type="tel" id="publisherPhone" value="+91 9876543210">
                    </div>
                </div>

                <div class="setting-card">
                    <h3>Company Information</h3>
                    <div class="setting-item">
                        <label>Company Name</label>
                        <input type="text" id="companyName" value="Your Company">
                    </div>
                    <div class="setting-item">
                        <label>Address</label>
                        <textarea id="companyAddress">Your company address</textarea>
                    </div>
                    <div class="setting-item">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" value="https://yourwebsite.com">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="updateProfile()">Update Profile</button>
            </div>
        </section>
    </main>
</div>

<!-- Modal for book details -->
<div id="bookModal" class="modal">
    <div class="modal-content large">
        <span class="close">&times;</span>
        <h2>Book Details</h2>
        <div id="bookDetails">
            <!-- Book details will be loaded here -->
        </div>
    </div>
</div>

<!-- Modal for edit book -->
<div id="editBookModal" class="modal">
    <div class="modal-content large">
        <span class="close">&times;</span>
        <h2>Edit Book</h2>
        <form id="editBookForm">
            <!-- Edit form will be loaded here -->
        </form>
    </div>
</div>

<script>
    // =============================================
    // ‚úÖ GLOBAL VARIABLES & CONFIGURATION
    // =============================================
    const API_BASE_URL = 'http://localhost:8035';
    let categories = [];
    let books = [];
    let currentPublisher = null;
    let currentUserId = null;
    let allReviews = [];

    // =============================================
    // ‚úÖ USER AUTHENTICATION & ID MANAGEMENT
    // =============================================

    function getCurrentUserId() {
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('userId');

        if (userId) {
            console.log('‚úÖ User ID from URL:', userId);
            localStorage.setItem('currentUserId', userId);
            currentUserId = parseInt(userId);
            return currentUserId;
        }

        userId = localStorage.getItem('currentUserId');
        if (userId) {
            console.log('‚úÖ User ID from localStorage:', userId);
            currentUserId = parseInt(userId);
            return currentUserId;
        }

        console.error('‚ùå No user ID found!');
        return null;
    }

    function initializeUser() {
        currentUserId = getCurrentUserId();
        const userIdInput = document.getElementById('userId');

        if (userIdInput) {
            userIdInput.value = currentUserId;
        }

        console.log('üë§ Current user ID:', currentUserId);

        if (!currentUserId) {
            showToast('User ID not found. Please login again.', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 3000);
        }

        return currentUserId;
    }

    function initializeUserFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');

        if (userId) {
            const userIdInput = document.getElementById('userId');
            if (userIdInput) {
                userIdInput.value = userId;
            }
            localStorage.setItem('currentUserId', userId);
            currentUserId = parseInt(userId);
            console.log('‚úÖ User ID set from URL:', currentUserId);
            return true;
        }
        return false;
    }

    // =============================================
    // ‚úÖ BASIC UI FUNCTIONS
    // =============================================

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });

        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });

        document.getElementById(sectionId).classList.add('active');
        const menuItem = document.querySelector(`.menu-item[onclick="showSection('${sectionId}')"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('currentPublisher');
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('jwtToken');
            sessionStorage.removeItem('jwtToken');
            currentUserId = null;
            window.location.href = '/login';
        }
    }

    function closeEditModal() {
        const editModal = document.getElementById('editBookModal');
        if (editModal) {
            editModal.style.display = 'none';
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    }

    // =============================================
    // ‚úÖ AUTHENTICATION FUNCTIONS
    // =============================================

    function getAuthToken() {
        return localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
    }

    async function authFetch(url, options = {}) {
        const token = getAuthToken();

        const headers = {
            ...options.headers
        };

        if (!(options.body instanceof FormData) && !headers['Content-Type']) {
            headers['Content-Type'] = 'application/json';
        }

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        try {
            const response = await fetch(url, {
                ...options,
                headers
            });

            if (response.status === 403) {
                console.error('Access forbidden - check authentication');
                showToast('Session expired. Please login again.', 'error');
                throw new Error('Authentication failed');
            }

            return response;
        } catch (error) {
            console.error('Fetch error:', error);
            throw error;
        }
    }

    // =============================================
    // ‚úÖ DASHBOARD INITIALIZATION
    // =============================================

    function initializeDashboard() {
        const token = getAuthToken();
        if (!token) {
            showToast('Please login to access publisher dashboard', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }

        const savedPublisher = localStorage.getItem('currentPublisher');
        if (savedPublisher) {
            currentPublisher = JSON.parse(savedPublisher);
            const publisherNameElem = document.getElementById('publisherName');
            const publisherNameInput = document.getElementById('publisherNameInput');

            if (publisherNameElem) {
                publisherNameElem.textContent = `Welcome, ${currentPublisher.name}`;
            }
            if (publisherNameInput) {
                publisherNameInput.value = currentPublisher.name;
            }
        }
    }

    function setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const coverUpload = document.getElementById('coverUpload');

        if (uploadArea && coverUpload) {
            uploadArea.addEventListener('click', () => {
                coverUpload.click();
            });

            coverUpload.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('coverPreview');
                        if (preview) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        }
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }

        const addBookForm = document.getElementById('addBookForm');
        if (addBookForm) {
            addBookForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addNewBook();
            });
        }

        window.addEventListener('click', function(event) {
            const bookModal = document.getElementById('bookModal');
            const editModal = document.getElementById('editBookModal');

            if (event.target == bookModal && bookModal) {
                bookModal.style.display = 'none';
            }

            if (event.target == editModal && editModal) {
                editModal.style.display = 'none';
            }
        });

        const closeButtons = document.querySelectorAll('.close');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        });
    }

    // =============================================
    // ‚úÖ CATEGORY MANAGEMENT FUNCTIONS - UPDATED
    // =============================================

    function setDefaultCategories() {
        categories = [
            { id: 1, categoryName: "FICTION", description: "Fiction books" },
            { id: 2, categoryName: "NON_FICTION", description: "Non-fiction books" },
            { id: 3, categoryName: "SCIENCE_FICTION", description: "Sci-Fi books" },
            { id: 4, categoryName: "MYSTERY", description: "Mystery books" },
            { id: 5, categoryName: "BIOGRAPHY", description: "Biography books" }
        ];
        console.log('üîÑ Using default categories:', categories.length);
        populateCategoryDropdowns();
    }

    async function loadCategories() {
        try {
            console.log('üîÑ Loading categories from API...');
            const response = await authFetch(`${API_BASE_URL}/category/apies/findAll`);

            if (response.ok) {
                const categoriesData = await response.json();
                console.log('üì• Categories API Response:', categoriesData);

                if (categoriesData && categoriesData.length > 0) {
                    categories = categoriesData;
                    console.log('‚úÖ Categories loaded successfully:', categories.length);
                } else {
                    console.log('‚ö†Ô∏è No categories found in API response, using defaults');
                    setDefaultCategories();
                    return;
                }
                populateCategoryDropdowns();
                updateCategoryFilters();
            } else {
                console.error('‚ùå Categories API failed with status:', response.status);
                setDefaultCategories();
            }
        } catch (error) {
            console.error('‚ùå Error loading categories:', error);
            setDefaultCategories();
        }
    }

    function populateCategoryDropdowns() {
        const addBookCategory = document.getElementById('bookCategory');
        const filterCategory = document.getElementById('categoryFilter');

        console.log('üîÑ Populating category dropdowns...');
        console.log('Available categories:', categories);

        // Clear and populate Book Category dropdown
        if (addBookCategory) {
            while (addBookCategory.options.length > 1) {
                addBookCategory.remove(1);
            }

            categories.forEach(category => {
                const option = new Option(category.categoryName, category.id);
                addBookCategory.add(option);
            });

            console.log('‚úÖ Book category dropdown populated with', categories.length, 'categories');
        }

        // Clear and populate Filter Category dropdown
        if (filterCategory) {
            while (filterCategory.options.length > 1) {
                filterCategory.remove(1);
            }

            categories.forEach(category => {
                const option = new Option(category.categoryName, category.id);
                filterCategory.add(option);
            });

            console.log('‚úÖ Filter category dropdown populated');
        }
    }

    // =============================================
    // ‚úÖ BOOK MANAGEMENT FUNCTIONS
    // =============================================

    async function loadBooksFromAPI() {
        try {
            console.log('üìö Loading books for user ID:', currentUserId);

            const response = await authFetch(`${API_BASE_URL}/book/apies/user/${currentUserId}`);

            if (response.ok) {
                const booksData = await response.json();
                books = booksData;

                // ‚úÖ DEBUG: Check book categories
                console.log('üì• Books loaded:', books.length);
                books.forEach((book, index) => {
                    console.log(`Book ${index + 1}:`, {
                        title: book.title,
                        category: book.category,
                        categoryId: book.category ? book.category.id : 'No category',
                        categoryName: book.category ? book.category.categoryName : 'No name'
                    });
                });

                // Load reviews for all books
                await loadAllReviews();

                renderBooksTable();
                updateDashboardStats();
                loadRecentBooks();
                updateCategoryDistribution();
                updateCategoryFilters();
            } else {
                console.error('‚ùå Failed to load books, status:', response.status);
                showToast('Failed to load books', 'error');
            }
        } catch (error) {
            console.error('‚ùå Error loading books:', error);
            showToast('Failed to load books: ' + error.message, 'error');
        }
    }

    // =============================================
    // ‚úÖ REVIEW MANAGEMENT FUNCTIONS
    // =============================================

    async function loadAllReviews() {
        try {
            console.log('üìù Loading all reviews...');
            allReviews = [];

            // Load reviews for each book
            for (const book of books) {
                try {
                    const response = await authFetch(`${API_BASE_URL}/review/apies/book/${book.id}`);
                    if (response.ok) {
                        const bookReviews = await response.json();
                        allReviews.push(...bookReviews);
                        console.log(`‚úÖ Loaded ${bookReviews.length} reviews for book ${book.id}`);
                    }
                } catch (error) {
                    console.error(`‚ùå Error loading reviews for book ${book.id}:`, error);
                }
            }

            console.log(`‚úÖ Total reviews loaded: ${allReviews.length}`);
        } catch (error) {
            console.error('‚ùå Error loading reviews:', error);
        }
    }

    function getBookReviews(bookId) {
        return allReviews.filter(review => review.bookId === bookId);
    }

    function calculateBookRatingStats(bookId) {
        const bookReviews = getBookReviews(bookId);
        const count = bookReviews.length;
        const averageRating = count > 0 ?
            bookReviews.reduce((sum, review) => sum + review.rating, 0) / count : 0;

        return {
            count,
            averageRating: parseFloat(averageRating.toFixed(1))
        };
    }

    function updateDashboardStats() {
        const totalBooks = books.length;
        const publishedBooks = books.filter(book =>
            book.status === 'published' || book.status === 'PUBLISHED' || book.status === 'APPROVED'
        ).length;
        const draftBooks = books.filter(book =>
            book.status === 'draft' || book.status === 'DRAFT' || book.status === 'PENDING' || !book.status
        ).length;

        const uniqueCategories = new Set();
        books.forEach(book => {
            if (book.category && book.category.id) {
                uniqueCategories.add(book.category.id);
            }
        });

        // Calculate total reviews and average rating across all books
        let totalReviews = 0;
        let totalRating = 0;
        let booksWithReviews = 0;

        books.forEach(book => {
            const stats = calculateBookRatingStats(book.id);
            if (stats.count > 0) {
                totalReviews += stats.count;
                totalRating += stats.averageRating;
                booksWithReviews++;
            }
        });

        const averageRating = booksWithReviews > 0 ? (totalRating / booksWithReviews) : 0;

        updateStats({
            totalBooks,
            publishedBooks,
            draftBooks,
            totalCategories: uniqueCategories.size,
            totalReviews,
            averageRating: parseFloat(averageRating.toFixed(1))
        });
    }

    function updateStats(stats) {
        const totalBooksElem = document.getElementById('totalBooks');
        const publishedBooksElem = document.getElementById('publishedBooks');
        const draftBooksElem = document.getElementById('draftBooks');
        const totalCategoriesElem = document.getElementById('totalCategories');
        const totalReviewsElem = document.getElementById('totalReviews');
        const averageRatingElem = document.getElementById('averageRating');

        if (totalBooksElem) totalBooksElem.textContent = stats.totalBooks;
        if (publishedBooksElem) publishedBooksElem.textContent = stats.publishedBooks;
        if (draftBooksElem) draftBooksElem.textContent = stats.draftBooks;
        if (totalCategoriesElem) totalCategoriesElem.textContent = stats.totalCategories;
        if (totalReviewsElem) totalReviewsElem.textContent = stats.totalReviews;
        if (averageRatingElem) averageRatingElem.textContent = stats.averageRating;
    }

    function loadPublisherData() {
        updateStats({
            totalBooks: 0,
            publishedBooks: 0,
            draftBooks: 0,
            totalCategories: 0,
            totalReviews: 0,
            averageRating: 0
        });
    }

    // =============================================
    // ‚úÖ RECENT BOOKS & CATEGORY DISTRIBUTION
    // =============================================

    function loadRecentBooks() {
        const recentBooksContainer = document.getElementById('recentBooks');
        if (!recentBooksContainer) return;

        const sortedBooks = [...books].sort((a, b) => {
            const dateA = new Date(a.uploadedAt || 0);
            const dateB = new Date(b.uploadedAt || 0);
            return dateB - dateA;
        });

        const recentBooks = sortedBooks.slice(0, 5);
        let html = '';

        if (recentBooks.length > 0) {
            recentBooks.forEach(book => {
                const statusClass = `status-${book.status || 'draft'}`;
                const date = book.uploadedAt ?
                    new Date(book.uploadedAt).toLocaleDateString() :
                    'Recent';

                const categoryName = book.category ?
                    (book.category.categoryName || book.category) :
                    'Uncategorized';

                // Get review stats for this book
                const reviewStats = calculateBookRatingStats(book.id);

                html += `
                    <div class="activity-item">
                        <div class="activity-info">
                            <h4>${book.title || 'Untitled'}</h4>
                            <div style="display: flex; gap: 8px; margin-top: 5px;">
                                <span class="status-badge ${statusClass}">${book.status || 'draft'}</span>
                                <span class="category-badge">${categoryName}</span>
                                ${reviewStats.count > 0 ?
                                    `<span class="rating-display">
                                        <span class="review-rating">${generateStarRating(reviewStats.averageRating)}</span>
                                        <span class="rating-value">(${reviewStats.averageRating})</span>
                                    </span>` :
                                    '<span style="color: #888; font-size: 0.8rem;">No reviews</span>'
                                }
                            </div>
                        </div>
                        <span class="activity-time">${date}</span>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="activity-item">
                    <div class="activity-info">
                        <h4>No books found</h4>
                        <p>Add your first book to see it here!</p>
                    </div>
                </div>
            `;
        }

        recentBooksContainer.innerHTML = html;
    }

    function updateCategoryDistribution() {
        const distributionContainer = document.getElementById('categoryDistribution');
        if (!distributionContainer) return;

        const categoryCounts = {};

        books.forEach(book => {
            let categoryName = 'Uncategorized';

            if (book.category) {
                categoryName = book.category.categoryName ||
                              (typeof book.category === 'string' ? book.category : 'Uncategorized');
            }

            categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
        });

        let html = '';

        if (Object.keys(categoryCounts).length > 0) {
            Object.entries(categoryCounts).forEach(([category, count]) => {
                const percentage = books.length > 0 ? ((count / books.length) * 100).toFixed(1) : 0;

                html += `
                    <div class="activity-item">
                        <div class="activity-info">
                            <h4>${category}</h4>
                            <span class="category-badge">${count} books</span>
                        </div>
                        <span class="activity-time">${percentage}%</span>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="activity-item">
                    <div class="activity-info">
                        <h4>No categories found</h4>
                        <p>Books will appear here once categories are assigned</p>
                    </div>
                </div>
            `;
        }

        distributionContainer.innerHTML = html;
    }

    function updateCategoryFilters() {
        const quickFilters = document.getElementById('quickCategoryFilters');
        if (!quickFilters) return;

        let html = '<div class="category-filter-btn active" onclick="filterBooksByCategory(\'\')">All</div>';

        const categoryCounts = {};
        books.forEach(book => {
            if (book.category && book.category.id) {
                categoryCounts[book.category.id] = (categoryCounts[book.category.id] || 0) + 1;
            }
        });

        const topCategories = Object.entries(categoryCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        topCategories.forEach(([categoryId, count]) => {
            const category = categories.find(c => c.id == categoryId);
            if (category) {
                html += `<div class="category-filter-btn" onclick="filterBooksByCategory(${categoryId})">
                          ${category.categoryName} (${count})
                         </div>`;
            }
        });

        quickFilters.innerHTML = html;
    }

    // =============================================
    // ‚úÖ BOOK TABLE & DISPLAY FUNCTIONS
    // =============================================
    function renderBooksTable(filteredBooks = null) {
        const booksToRender = filteredBooks || books;
        const tableBody = document.getElementById('bookTableBody');

        if (!tableBody) return;

        if (!booksToRender || booksToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No books found</td></tr>';
            return;
        }

        let html = '';
        booksToRender.forEach(book => {
            const statusClass = `status-${book.status || 'draft'}`;
            const date = book.uploadedAt ?
                new Date(book.uploadedAt).toLocaleDateString() :
                new Date().toLocaleDateString();

            const coverUrl = book.coverImagePath ?
                `${API_BASE_URL}/uploads/${book.coverImagePath}` :
                generatePlaceholderSvg(book.title);

            // ‚úÖ IMPROVED CATEGORY HANDLING
            let categoryName = 'Uncategorized';
            let categoryId = null;

            if (book.category) {
                // Agar category object hai
                categoryName = book.category.categoryName || 'Uncategorized';
                categoryId = book.category.id;
            } else if (book.categoryId) {
                // Agar sirf categoryId hai
                const category = categories.find(cat => cat.id === book.categoryId);
                categoryName = category ? category.categoryName : `Category ${book.categoryId}`;
                categoryId = book.categoryId;
            }

            // Get review stats for this book
            const reviewStats = calculateBookRatingStats(book.id);

            console.log(`üìñ Book "${book.title}":`, {
                categoryObject: book.category,
                categoryId: book.categoryId,
                resolvedCategory: categoryName,
                reviewStats: reviewStats
            });

            html += `
                <tr>
                    <td class="book-cover-cell">
                        <img src="${coverUrl}" alt="${book.title}"
                             onerror="this.src='${generatePlaceholderSvg(book.title)}'">
                    </td>
                    <td>${book.title || 'Untitled'}</td>
                    <td>${book.author || 'Unknown Author'}</td>
                    <td><span class="category-badge">${categoryName}</span></td>
                    <td>
                        ${reviewStats.count > 0 ?
                            `<span class="review-count-badge">${reviewStats.count}</span>` :
                            '<span style="color: #888;">0</span>'
                        }
                    </td>
                    <td>
                        ${reviewStats.count > 0 ?
                            `<div class="rating-display">
                                <span class="review-rating">${generateStarRating(reviewStats.averageRating)}</span>
                                <span class="rating-value">${reviewStats.averageRating}</span>
                            </div>` :
                            '<span style="color: #888;">No rating</span>'
                        }
                    </td>
                    <td>${book.language || 'English'}</td>
                    <td><span class="status-badge ${statusClass}">${book.status || 'draft'}</span></td>
                    <td>${date}</td>
                    <td>
                        <div class="book-actions">
                            <button class="btn-primary btn-sm" onclick="viewBook(${book.id})">View</button>
                            <button class="btn-secondary btn-sm" onclick="editBook(${book.id})">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteBook(${book.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
    }

    function generatePlaceholderSvg(title) {
        const initials = title ? title.charAt(0).toUpperCase() : 'B';
        const svg = `
            <svg width="50" height="65" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#4a90e2"/>
                <text x="50%" y="50%" font-family="Arial" font-size="20" fill="white"
                      text-anchor="middle" dy=".3em">${initials}</text>
            </svg>
        `;
        return 'data:image/svg+xml;base64,' + btoa(svg);
    }

    // =============================================
    // ‚úÖ BOOK EVENT HANDLERS - BACKEND CRUD
    // =============================================

    async function addNewBook() {
        const submitBtn = document.querySelector('#addBookForm button[type="submit"]');
        const spinner = document.getElementById('submitSpinner');

        try {
            submitBtn.disabled = true;
            if (spinner) spinner.style.display = 'inline-block';

            if (!currentUserId) {
                throw new Error('User ID not found. Please login again.');
            }

            const formData = new FormData();

            const bookData = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                description: document.getElementById('bookDescription').value,
                language: document.getElementById('bookLanguage').value,
                userId: currentUserId,
                categoryId: document.getElementById('bookCategory').value || null,
                status: "PENDING"
            };

            console.log('üì§ Sending book data for user:', currentUserId, 'Data:', bookData);

            formData.append('book', JSON.stringify(bookData));

            const pdfFile = document.getElementById('bookFile').files[0];
            const coverFile = document.getElementById('coverUpload').files[0];

            if (!pdfFile) {
                throw new Error('Please select a book file (PDF/TXT)');
            }

            if (pdfFile) {
                formData.append('file', pdfFile);
            }
            if (coverFile) {
                formData.append('cover', coverFile);
            }

            const response = await authFetch(`${API_BASE_URL}/book/apies/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Upload failed with status: ${response.status}`);
            }

            const result = await response.text();
            showToast('Book created successfully!', 'success');

            document.getElementById('addBookForm').reset();
            const coverPreview = document.getElementById('coverPreview');
            if (coverPreview) coverPreview.style.display = 'none';

            setTimeout(() => {
                loadBooksFromAPI();
                showSection('myBooks');
            }, 1500);

        } catch (error) {
            console.error('‚ùå Error creating book:', error);
            showToast('Failed to create book: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            if (spinner) spinner.style.display = 'none';
        }
    }

    function viewBook(bookId) {
        const book = books.find(b => b.id === bookId);
        if (!book) return;

        const modal = document.getElementById('bookModal');
        const bookDetails = document.getElementById('bookDetails');

        if (!modal || !bookDetails) return;

        const coverUrl = book.coverImagePath ?
            `${API_BASE_URL}/uploads/${book.coverImagePath}` :
            generatePlaceholderSvg(book.title);

        const date = new Date(book.uploadedAt).toLocaleDateString();
        const categoryName = book.category ? book.category.categoryName : 'Uncategorized';

        bookDetails.innerHTML = `
            <div class="book-detail-view">
                <div class="book-cover-large">
                    <img src="${coverUrl}" alt="${book.title}"
                         onerror="this.src='${generatePlaceholderSvg(book.title)}'">
                </div>
                <div class="book-info">
                    <h3>${book.title}</h3>
                    <p><strong>Author:</strong> ${book.author}</p>
                    <p><strong>Category:</strong> <span class="category-badge">${categoryName}</span></p>
                    <p><strong>Language:</strong> ${book.language || 'English'}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${book.status || 'draft'}">${book.status || 'draft'}</span></p>
                    <p><strong>Date Added:</strong> ${date}</p>
                    <p><strong>Description:</strong> ${book.description || 'No description available.'}</p>
                    ${book.fileName ? `<p><strong>File:</strong> ${book.fileName}</p>` : ''}
                    ${book.fileSize ? `<p><strong>File Size:</strong> ${(book.fileSize / 1024 / 1024).toFixed(2)} MB</p>` : ''}
                    ${book.extractedText ? `<p><strong>Content Preview:</strong> ${book.extractedText.substring(0, 200)}...</p>` : ''}
                </div>
            </div>

            <!-- ‚úÖ REVIEWS SECTION ADDED -->
            <div class="reviews-section" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>üìù Reader Reviews</h3>
                <div id="reviewsContent-${book.id}">
                    <p>Loading reviews...</p>
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-primary" onclick="closeModal('bookModal')">Close</button>
            </div>
        `;

        modal.style.display = 'block';

        // ‚úÖ Load reviews for this book
        loadBookReviewsForModal(book.id);
    }

    function editBook(bookId) {
        const book = books.find(b => b.id === bookId);
        if (!book) {
            showToast('Book not found', 'error');
            return;
        }

        const modal = document.getElementById('editBookModal');
        const editForm = document.getElementById('editBookForm');

        if (!modal || !editForm) return;

        let categoryOptions = '';
        categories.forEach(category => {
            const selected = book.category && book.category.id === category.id ? 'selected' : '';
            categoryOptions += `<option value="${category.id}" ${selected}>${category.categoryName}</option>`;
        });

        editForm.innerHTML = `
            <input type="hidden" id="editBookId" value="${book.id}">
            <div class="form-row">
                <div class="form-group">
                    <label for="editBookTitle">Book Title *</label>
                    <input type="text" id="editBookTitle" value="${book.title || ''}" required>
                </div>
                <div class="form-group">
                    <label for="editBookAuthor">Author *</label>
                    <input type="text" id="editBookAuthor" value="${book.author || ''}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editBookCategory">Category</label>
                    <select id="editBookCategory">
                        <option value="">Select Category</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="editBookLanguage">Language *</label>
                    <input type="text" id="editBookLanguage" value="${book.language || 'English'}" required>
                </div>
            </div>

            <div class="form-group">
                <label for="editBookDescription">Description</label>
                <textarea id="editBookDescription" rows="4">${book.description || ''}</textarea>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-primary">Update Book</button>
            </div>
        `;

        modal.style.display = 'block';

        editForm.onsubmit = async function(e) {
            e.preventDefault();
            await updateBook(bookId);
        };
    }

    async function updateBook(bookId) {
        try {
            if (!currentUserId) {
                throw new Error('User ID not found. Please login again.');
            }

            const bookData = {
                title: document.getElementById('editBookTitle').value,
                author: document.getElementById('editBookAuthor').value,
                description: document.getElementById('editBookDescription').value,
                language: document.getElementById('editBookLanguage').value,
                userId: currentUserId,
                categoryId: document.getElementById('editBookCategory').value || null
            };

            const response = await authFetch(`${API_BASE_URL}/book/apies/Update/${bookId}`, {
                method: 'PUT',
                body: JSON.stringify(bookData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to update book');
            }

            const result = await response.text();
            showToast('Book updated successfully!', 'success');

            await loadBooksFromAPI();
            closeEditModal();

        } catch (error) {
            console.error('‚ùå Error updating book:', error);
            showToast('Failed to update book: ' + error.message, 'error');
        }
    }

    async function deleteBook(bookId) {
        if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
            try {
                const response = await authFetch(`${API_BASE_URL}/book/apies/delete/${bookId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to delete book');
                }

                const result = await response.text();
                showToast('Book deleted successfully!', 'success');

                await loadBooksFromAPI();

            } catch (error) {
                console.error('‚ùå Error deleting book:', error);
                showToast('Failed to delete book: ' + error.message, 'error');
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // =============================================
    // ‚úÖ REVIEW MANAGEMENT FUNCTIONS
    // =============================================

    async function loadBookReviewsForModal(bookId) {
        try {
            console.log(`üìù Loading reviews for book ${bookId}...`);

            const response = await authFetch(`${API_BASE_URL}/review/apies/book/${bookId}`);
            const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);

            if (!reviewsContent) return;

            if (response.ok) {
                const reviews = await response.json();
                console.log(`‚úÖ Loaded ${reviews.length} reviews for book ${bookId}`);
                displayReviewsInModal(bookId, reviews);
            } else {
                reviewsContent.innerHTML = `
                    <div class="no-reviews">
                        <p>‚ùå Failed to load reviews. Please try again.</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error(`‚ùå Error loading reviews for book ${bookId}:`, error);
            const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);
            if (reviewsContent) {
                reviewsContent.innerHTML = `
                    <div class="no-reviews">
                        <p>‚ùå Error loading reviews: ${error.message}</p>
                    </div>
                `;
            }
        }
    }

    function displayReviewsInModal(bookId, reviews) {
        const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);
        if (!reviewsContent) return;

        if (!reviews || reviews.length === 0) {
            reviewsContent.innerHTML = `
                <div class="no-reviews">
                    <p>üì≠ No reviews yet. Be the first to review this book!</p>
                </div>
            `;
            return;
        }

        // Calculate average rating
        const averageRating = calculateAverageRating(reviews);
        const totalReviews = reviews.length;

        let html = `
            <div class="reviews-summary">
                <div class="average-rating">
                    <div class="rating-stars-large">${generateStarRating(averageRating)}</div>
                    <div class="rating-details">
                        <strong>${averageRating.toFixed(1)}</strong> out of 5
                        <span class="review-count">(${totalReviews} ${totalReviews === 1 ? 'review' : 'reviews'})</span>
                    </div>
                </div>
            </div>

            <div class="reviews-list" style="margin-top: 20px;">
                <h4>Recent Reviews</h4>
        `;

        // Show latest 5 reviews
        const recentReviews = reviews
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
            .slice(0, 5);

        recentReviews.forEach(review => {
            const reviewDate = new Date(review.createdAt).toLocaleDateString();
            const userName = review.user ? review.user.name : 'Anonymous User';

            html += `
                <div class="review-item">
                    <div class="review-header">
                        <div>
                            <strong>${userName}</strong>
                            <div class="review-rating">${generateStarRating(review.rating)}</div>
                        </div>
                        <span class="review-date">${reviewDate}</span>
                    </div>
                    <div class="review-text">
                        ${review.reviewText || 'No review text provided.'}
                    </div>
                </div>
            `;
        });

        if (reviews.length > 5) {
            html += `
                <div style="text-align: center; margin-top: 15px;">
                    <small>+ ${reviews.length - 5} more reviews</small>
                </div>
            `;
        }

        html += `</div>`;
        reviewsContent.innerHTML = html;
    }

    function calculateAverageRating(reviews) {
        if (!reviews || reviews.length === 0) return 0;
        const total = reviews.reduce((sum, review) => sum + review.rating, 0);
        return total / reviews.length;
    }

    function generateStarRating(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

        return '‚≠ê'.repeat(fullStars) +
               (hasHalfStar ? '‚≠ê' : '') +
               '‚òÜ'.repeat(emptyStars);
    }

    // =============================================
    // ‚úÖ SEARCH & FILTER FUNCTIONS
    // =============================================

    function searchBooks() {
        const searchTerm = document.getElementById('bookSearch').value.toLowerCase();
        if (!searchTerm.trim()) {
            renderBooksTable();
            return;
        }

        const filteredBooks = books.filter(book =>
            (book.title && book.title.toLowerCase().includes(searchTerm)) ||
            (book.author && book.author.toLowerCase().includes(searchTerm)) ||
            (book.category &&
             ((book.category.categoryName && book.category.categoryName.toLowerCase().includes(searchTerm)) ||
              (typeof book.category === 'string' && book.category.toLowerCase().includes(searchTerm))))
        );

        renderBooksTable(filteredBooks);
    }

    function filterBooks() {
        const status = document.getElementById('statusFilter').value;
        const category = document.getElementById('categoryFilter').value;

        let filteredBooks = books;

        if (status) {
            filteredBooks = filteredBooks.filter(book =>
                book.status && book.status.toLowerCase() === status.toLowerCase()
            );
        }

        if (category) {
            filteredBooks = filteredBooks.filter(book =>
                book.category && book.category.id == category
            );
        }

        renderBooksTable(filteredBooks);
    }

    function filterBooksByCategory(categoryId) {
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        event.target.classList.add('active');

        if (!categoryId) {
            renderBooksTable();
            return;
        }

        const filteredBooks = books.filter(book =>
            book.category && book.category.id == categoryId
        );
        renderBooksTable(filteredBooks);
    }

    // =============================================
    // ‚úÖ PROFILE MANAGEMENT
    // =============================================

    function updateProfile() {
        const name = document.getElementById('publisherNameInput').value;
        const publisherNameElem = document.getElementById('publisherName');

        if (publisherNameElem) {
            publisherNameElem.textContent = `Welcome, ${name}`;
        }

        if (currentPublisher) {
            currentPublisher.name = name;
            localStorage.setItem('currentPublisher', JSON.stringify(currentPublisher));
        }

        showToast('Profile updated successfully!', 'success');
    }

    // =============================================
    // ‚úÖ PAGE INITIALIZATION
    // =============================================

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing dashboard...');

        if (!initializeUserFromURL()) {
            initializeUser();
        }

        initializeDashboard();
        setupEventListeners();
        loadPublisherData();
        loadCategories();
        loadBooksFromAPI();

        const favicon = document.querySelector('link[rel="icon"]');
        if (!favicon) {
            const newFavicon = document.createElement('link');
            newFavicon.rel = 'icon';
            newFavicon.href = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>';
            document.head.appendChild(newFavicon);
        }
    });
</script>

</body>
</html>