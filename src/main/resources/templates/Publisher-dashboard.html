<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Dashboard | Intelli-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header Styles */
        .admin-header {
            background: linear-gradient(135deg, #4a90e2, #5a6ae4);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            font-family: 'Chakra Petch', sans-serif;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* Main Container */
        .admin-container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #eee;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            color: #4a90e2;
        }

        .sidebar-menu {
            list-style: none;
            margin-top: 20px;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: #f0f5ff;
            border-left-color: #4a90e2;
        }

        .menu-item.active {
            background: #e6f0ff;
            border-left: 3px solid #4a90e2;
            color: #4a90e2;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f7fa;
            transition: all 0.3s ease;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 30px;
        }

        .section-header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #333;
        }

        .section-header p {
            color: #666;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Stats Cards */
        .publisher-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            border-left: 4px solid #4a90e2;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .stat-card.primary {
            border-left-color: #4a90e2;
        }

        .stat-card.success {
            border-left-color: #28a745;
        }

        .stat-card.warning {
            border-left-color: #ffc107;
        }

        .stat-card.info {
            border-left-color: #17a2b8;
        }

        .stat-card.danger {
            border-left-color: #dc3545;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card.primary .stat-icon {
            background: #e6f0ff;
            color: #4a90e2;
        }

        .stat-card.success .stat-icon {
            background: #e8f5e8;
            color: #28a745;
        }

        .stat-card.warning .stat-icon {
            background: #fff8e1;
            color: #ffc107;
        }

        .stat-card.info .stat-icon {
            background: #e1f5fe;
            color: #17a2b8;
        }

        .stat-card.danger .stat-icon {
            background: #ffe6e6;
            color: #dc3545;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Activity Sections */
        .activity-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .activity-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .activity-info h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .activity-time {
            color: #888;
            font-size: 0.85rem;
        }

        /* Search and Filters */
        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Chakra Petch', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Chakra Petch', sans-serif;
            background: white;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .upload-area:hover {
            border-color: #4a90e2;
            background-color: #f8f9fa;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #4a90e2;
            background-color: #e6f0ff;
            transform: scale(1.02);
        }

        .upload-area i {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .book-cover-preview {
            max-width: 150px;
            max-height: 200px;
            border-radius: 5px;
            margin: 10px auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Chakra Petch', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Action Buttons */
        .book-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published {
            background-color: #d1edff;
            color: #0c5460;
        }

        .status-draft {
            background-color: #fff3cd;
            color: #856404;
        }

        .book-cover-cell {
            width: 60px;
        }

        .book-cover-cell img {
            width: 50px;
            height: 65px;
            object-fit: cover;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .book-cover-cell img:hover {
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #3a80d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content.large {
            max-width: 800px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #000;
            transform: scale(1.1);
        }

        /* Book Detail View */
        .book-detail-view {
            display: flex;
            gap: 30px;
        }

        .book-cover-large img {
            width: 200px;
            height: 280px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .book-cover-large img:hover {
            transform: scale(1.05);
        }

        .book-info {
            flex: 1;
        }

        .book-info h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #333;
        }

        .book-info p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .chart-placeholder {
            height: 250px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .setting-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .setting-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .setting-card h3 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .setting-item input,
        .setting-item textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Chakra Petch', sans-serif;
            transition: all 0.3s ease;
        }

        .setting-item input:focus,
        .setting-item textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        .setting-item textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Chakra Petch', sans-serif;
        }

        .pagination button.active {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        .pagination button:hover:not(.active) {
            background: #f5f5f5;
            transform: translateY(-2px);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
            text-align: center;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast.warning {
            background-color: #ffc107;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Category Specific Styles */
        .category-badge {
            padding: 4px 8px;
            background: #e9ecef;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #495057;
        }

        .category-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-filter-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Chakra Petch', sans-serif;
        }

        .category-filter-btn.active {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }

        .category-filter-btn:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        /* Review Specific Styles */
        .reviews-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .average-rating {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rating-stars-large {
            font-size: 24px;
            color: #ffc107;
        }

        .rating-details {
            display: flex;
            flex-direction: column;
        }

        .rating-details strong {
            font-size: 1.5rem;
            color: #333;
        }

        .review-count {
            color: #666;
            font-size: 0.9rem;
        }

        .no-reviews {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .review-item {
            background: white;
            transition: all 0.3s ease;
            border: 1px solid #eee;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .review-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .review-rating {
            color: #ffc107;
            font-size: 16px;
        }

        .review-date {
            color: #666;
            font-size: 0.9rem;
        }

        .review-text {
            color: #333;
            line-height: 1.5;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-value {
            color: #666;
            font-size: 0.9rem;
        }

        .review-count-badge {
            background: #4a90e2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.1);
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* Logout Confirmation Popup Styles */
        .logout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .logout-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            padding: 30px;
            text-align: center;
            width: 320px;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }

        .logout-modal h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .logout-modal p {
            font-size: 15px;
            color: #555;
            margin-bottom: 25px;
        }

        .logout-btn-group {
            display: flex;
            justify-content: space-around;
        }

        .logout-confirm-btn {
            background: #ff4d4d;
            color: white;
            padding: 10px 22px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s ease;
            font-family: 'Chakra Petch', sans-serif;
        }

        .logout-confirm-btn:hover {
            background: #e60000;
        }

        .logout-cancel-btn {
            background: #ddd;
            color: #333;
            padding: 10px 22px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s ease;
            font-family: 'Chakra Petch', sans-serif;
        }

        .logout-cancel-btn:hover {
            background: #ccc;
        }

        /* Publisher Suggestion Styles */
        .suggestion-reason {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #4a90e2;
            font-size: 0.9rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upvote-count, .interest-count {
            background: rgba(67, 97, 238, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            color: #4a90e2;
            font-size: 0.8rem;
        }

        .suggestion-details {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }

        .suggestion-details h3 {
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .suggestion-details p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .loading-cell {
            text-align: center;
            padding: 40px !important;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px !important;
            color: #666;
        }

        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            color: #ddd;
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .book-title {
            line-height: 1.4;
        }

        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d1edff;
            color: #0c5460;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: fixed;
                top: 70px;
                left: -100%;
                height: calc(100vh - 70px);
                z-index: 100;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                padding: 20px;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .book-detail-view {
                flex-direction: column;
                gap: 20px;
            }

            .book-cover-large {
                align-self: center;
            }

            .modal-content {
                width: 90%;
                margin: 10% auto;
                padding: 20px;
            }

            .analytics-grid,
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .chart-card,
            .setting-card {
                min-width: 0;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-info {
                justify-content: center;
            }

            .header-actions {
                flex-direction: column;
            }

            .publisher-stats {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .book-actions {
                flex-direction: column;
                gap: 5px;
            }

            .category-filters {
                justify-content: center;
            }

            .table-container {
                border-radius: 5px;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px 8px;
            }

            .average-rating {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .upload-area {
                padding: 20px;
            }

            .upload-area i {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .header-left h1 {
                font-size: 1.5rem;
            }

            .section-header h1 {
                font-size: 1.5rem;
            }

            .main-content {
                padding: 15px;
            }

            .stat-card {
                padding: 15px;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .book-cover-large img {
                width: 150px;
                height: 210px;
            }

            .chart-card,
            .setting-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading">
    <div class="spinner"></div>
    <p>Processing your request...</p>
</div>

<!-- Toast notifications -->
<div id="toast" class="toast"></div>

<!-- Logout Confirmation Popup -->
<div class="logout-overlay" id="logoutOverlay">
    <div class="logout-modal">
        <h2><i class='bx bx-log-out'></i> Confirm Logout</h2>
        <p>Are you sure you want to log out from this session?</p>
        <div class="logout-btn-group">
            <button class="logout-confirm-btn" id="confirmLogout">Yes, Logout</button>
            <button class="logout-cancel-btn" id="cancelLogout">Cancel</button>
        </div>
    </div>
</div>

<!-- Header -->
<header class="admin-header">
    <div class="header-content">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Toggle menu">
            <i class='bx bx-menu'></i>
        </button>
        <div class="header-left">
            <h1>ðŸ“š Intelli-Read Publisher</h1>
        </div>
        <div class="header-right">
            <div class="admin-info">
                <span id="publisherName">Welcome, Publisher</span>

                <!-- âœ… ADD REFRESH BUTTON -->
                <button class="logout-btn" onclick="refreshSuggestions()" title="Refresh Suggestions">
                    <i class='bx bx-refresh'></i> Refresh
                </button>

                <button class="logout-btn" id="logoutBtn">
                    <i class='bx bx-log-out'></i> Logout
                </button>
            </div>
        </div>
    </div>
</header>

<div class="admin-container">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Publisher Panel</h2>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item active" onclick="showSection('dashboard')">
                <i class='bx bx-dashboard'></i>
                <span>Dashboard</span>
            </li>
            <li class="menu-item" onclick="showSection('myBooks')">
                <i class='bx bx-book'></i>
                <span>My Books</span>
            </li>
            <li class="menu-item" onclick="showSection('addBook')">
                <i class='bx bx-plus-circle'></i>
                <span>Add New Book</span>
            </li>

            <!-- âœ… YEH NAYA ITEM ADD KARO -->
            <li class="menu-item" onclick="showSection('suggestions')">
                <i class='bx bx-bulb'></i>
                <span>Book Suggestions</span>
            </li>

            <li class="menu-item" onclick="showSection('analytics')">
                <i class='bx bx-bar-chart'></i>
                <span>Book Analytics</span>
            </li>
            <li class="menu-item" onclick="showSection('profile')">
                <i class='bx bx-user'></i>
                <span>Profile</span>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <h1>Publisher Dashboard</h1>
                <p>Manage your books and track performance</p>
            </div>

            <!-- Stats Cards -->
            <div class="publisher-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalBooks">0</h3>
                        <p>Total Books</p>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class='bx bx-check-circle'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="publishedBooks">0</h3>
                        <p>Published Books</p>
                    </div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class='bx bx-time'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="draftBooks">0</h3>
                        <p>Draft Books</p>
                    </div>
                </div>

                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class='bx bx-star'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalReviews">0</h3>
                        <p>Total Reviews</p>
                    </div>
                </div>

                <div class="stat-card danger">
                    <div class="stat-icon">
                        <i class='bx bx-trending-up'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="averageRating">0</h3>
                        <p>Avg. Rating</p>
                    </div>
                </div>
            </div>

            <!-- Recent Books -->
            <div class="activity-section">
                <div class="activity-card">
                    <h3>Recent Books</h3>
                    <div class="activity-list" id="recentBooks">
                        <!-- Recent books will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="activity-section" style="margin-top: 20px;">
                <div class="activity-card">
                    <h3>Category Distribution</h3>
                    <div id="categoryDistribution">
                        <!-- Category stats will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- My Books Section -->
        <section id="myBooks" class="section">
            <div class="section-header">
                <h1>My Books</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class='bx bx-search'></i>
                        <input type="text" id="bookSearch" placeholder="Search books..." onkeyup="searchBooks()">
                    </div>
                    <select id="statusFilter" onchange="filterBooks()">
                        <option value="">All Status</option>
                        <option value="published">Published</option>
                        <option value="draft">Draft</option>
                    </select>
                    <select id="categoryFilter" onchange="filterBooks()">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
            </div>

            <!-- Category Filters -->
            <div class="category-filters" id="quickCategoryFilters">
                <!-- Quick category filters will be loaded here -->
            </div>

            <div class="table-container">
                <table id="bookTable">
                    <thead>
                    <tr>
                        <th class="book-cover-cell">Cover</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Reviews</th>
                        <th>Rating</th>
                        <th>Language</th>
                        <th>Status</th>
                        <th>Date Added</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="bookTableBody">
                    <!-- Books will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="bookPagination">
                <!-- Pagination will be loaded here -->
            </div>
        </section>

        <!-- Add Book Section -->
        <section id="addBook" class="section">
            <div class="section-header">
                <h1>Add New Book</h1>
                <p>Upload and publish your books to Intelli-Read</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <i class='bx bx-cloud-upload'></i>
                <h3>Upload Book Cover</h3>
                <p>Drag & drop or click to upload book cover image</p>
                <input type="file" id="coverUpload" accept="image/*" style="display: none;">
                <img id="coverPreview" class="book-cover-preview" style="display: none;">
            </div>

            <form id="addBookForm">
                <input type="hidden" id="userId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="bookTitle">Book Title *</label>
                        <input type="text" id="bookTitle" required maxlength="255">
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Author *</label>
                        <input type="text" id="bookAuthor" required maxlength="255">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bookCategory">Category *</label>
                        <select id="bookCategory" required>
                            <option value="">Select Category</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookLanguage">Language *</label>
                        <input type="text" id="bookLanguage" value="English" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bookDescription">Book Description</label>
                    <textarea id="bookDescription" placeholder="Enter book description..." maxlength="1000"></textarea>
                </div>

                <div class="form-group">
                    <label for="bookFile">Upload Book File (PDF/TXT) *</label>
                    <input type="file" id="bookFile" accept=".pdf,.txt" required>
                    <small>Only PDF and TXT files are allowed (max 10MB)</small>
                </div>

                <div class="action-buttons">
                    <button type="reset" class="btn-secondary" onclick="resetBookForm()">Clear Form</button>
                    <button type="submit" class="btn-primary" id="submitBookBtn">
                        <span class="loading-spinner" id="submitSpinner"></span>
                        Save Book
                    </button>
                </div>
            </form>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="section">
            <div class="section-header">
                <h1>Book Analytics</h1>
                <p>Track your book performance and reader engagement</p>
            </div>

            <div class="analytics-grid">
                <div class="chart-card">
                    <h3>Category Performance</h3>
                    <div class="chart-placeholder" id="categoryPerformanceChart">
                        <p>Category-wise book performance</p>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Reader Engagement by Category</h3>
                    <div class="chart-placeholder" id="readerEngagementChart">
                        <p>Reader engagement metrics by category</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- âœ… NEW: Suggestions Section for Publishers -->
        <section id="suggestions" class="section">
            <div class="section-header">
                <h1>Book Suggestions from Users</h1>
                <p>Discover books that users want to read. Express interest or upload books directly.</p>
                <div class="header-actions">
                    <div class="search-box">
                        <i class='bx bx-search'></i>
                        <input type="text" id="suggestionSearch" placeholder="Search suggestions..." onkeyup="searchPublisherSuggestions()">
                    </div>
                    <select id="suggestionFilter" onchange="filterPublisherSuggestions()">
                        <option value="all">All Suggestions</option>
                        <option value="interested">Interested</option>
                        <option value="uploaded">Uploaded</option>
                        <option value="trending">Trending</option>
                    </select>
                </div>
            </div>

            <!-- Stats Cards for Suggestions -->
            <div class="publisher-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class='bx bx-bulb'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalPublisherSuggestions">0</h3>
                        <p>Total Suggestions</p>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class='bx bx-show'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="interestedPublisherSuggestions">0</h3>
                        <p>You're Interested In</p>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class='bx bx-book'></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="uploadedPublisherSuggestions">0</h3>
                        <p>Books Uploaded</p>
                    </div>
                </div>
            </div>

            <!-- Suggestions List -->
            <div class="table-container">
                <table id="suggestionTable">
                    <thead>
                    <tr>
                        <th>Title & Author</th>
                        <th>Suggested By</th>
                        <th>Reason</th>
                        <th>Upvotes</th>
                        <th>Publisher Interest</th>
                        <th>Your Action</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="suggestionTableBody">
                    <tr>
                        <td colspan="8" class="loading-cell">
                            <div class="loading-spinner"></div>
                            Loading suggestions...
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="suggestionPagination">
                <!-- Pagination will be loaded here -->
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile" class="section">
            <div class="section-header">
                <h1>Publisher Profile</h1>
                <p>Manage your publisher account information</p>
            </div>

            <div class="settings-grid">
                <div class="setting-card">
                    <h3>Account Information</h3>
                    <div class="setting-item">
                        <label>Publisher Name</label>
                        <input type="text" id="publisherNameInput" value="Your Publisher Name">
                    </div>
                    <div class="setting-item">
                        <label>Contact Email</label>
                        <input type="email" id="publisherEmail" value="publisher@example.com">
                    </div>
                    <div class="setting-item">
                        <label>Phone Number</label>
                        <input type="tel" id="publisherPhone" value="+91 9876543210">
                    </div>
                </div>

                <div class="setting-card">
                    <h3>Company Information</h3>
                    <div class="setting-item">
                        <label>Company Name</label>
                        <input type="text" id="companyName" value="Your Company">
                    </div>
                    <div class="setting-item">
                        <label>Address</label>
                        <textarea id="companyAddress">Your company address</textarea>
                    </div>
                    <div class="setting-item">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" value="https://yourwebsite.com">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="updateProfile()">Update Profile</button>
            </div>
        </section>
    </main>
</div>

<!-- Modal for book details -->
<div id="bookModal" class="modal">
    <div class="modal-content large">
        <span class="close">&times;</span>
        <h2>Book Details</h2>
        <div id="bookDetails">
            <!-- Book details will be loaded here -->
        </div>
    </div>
</div>

<!-- Modal for edit book -->
<div id="editBookModal" class="modal">
    <div class="modal-content large">
        <span class="close">&times;</span>
        <h2>Edit Book</h2>
        <form id="editBookForm">
            <!-- Edit form will be loaded here -->
        </form>
    </div>
</div>

<script>
    // =============================================
// âœ… GLOBAL VARIABLES & CONFIGURATION
// =============================================
const API_BASE_URL = 'http://localhost:8035';
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

// âœ… CORRECTED API Endpoints
const SUGGESTION_API = {
    GET_ALL: `${API_BASE_URL}/suggestion/all`,
    GET_BY_PUBLISHER: `${API_BASE_URL}/suggestion/publisher`,
    EXPRESS_INTEREST: `${API_BASE_URL}/suggestion/interest`,
    UPLOAD_FOR_SUGGESTION: `${API_BASE_URL}/suggestion/upload`,
    GET_DETAILS: `${API_BASE_URL}/suggestion`
};

let categories = [];
let books = [];
let currentPublisher = null;
let currentUserId = null;
let allReviews = [];
let currentPage = 1;
const booksPerPage = 6;

// =============================================
// âœ… USER AUTHENTICATION & ID MANAGEMENT
// =============================================

/**
 * Get current user ID from URL parameters or localStorage
 * @returns {number|null} User ID or null if not found
 */
function getCurrentUserId() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('userId');

        if (userId) {
            console.log('âœ… User ID from URL:', userId);
            localStorage.setItem('currentUserId', userId);
            currentUserId = parseInt(userId);
            return currentUserId;
        }

        userId = localStorage.getItem('currentUserId');
        if (userId) {
            console.log('âœ… User ID from localStorage:', userId);
            currentUserId = parseInt(userId);
            return currentUserId;
        }

        console.error('âŒ No user ID found!');
        showToast('User session not found. Please login again.', 'error');
        return null;
    } catch (error) {
        console.error('âŒ Error getting user ID:', error);
        return null;
    }
}

/**
 * Initialize user session and validate authentication
 */
function initializeUser() {
    try {
        currentUserId = getCurrentUserId();
        const userIdInput = document.getElementById('userId');

        if (userIdInput && currentUserId) {
            userIdInput.value = currentUserId;
        }

        console.log('ðŸ‘¤ Current user ID:', currentUserId);

        if (!currentUserId) {
            showToast('User ID not found. Please login again.', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 3000);
            return false;
        }

        return true;
    } catch (error) {
        console.error('âŒ Error initializing user:', error);
        showToast('Error initializing user session.', 'error');
        return false;
    }
}

/**
 * Initialize user from URL parameters
 * @returns {boolean} Success status
 */
function initializeUserFromURL() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');

        if (userId) {
            const userIdInput = document.getElementById('userId');
            if (userIdInput) {
                userIdInput.value = userId;
            }
            localStorage.setItem('currentUserId', userId);
            currentUserId = parseInt(userId);
            console.log('âœ… User ID set from URL:', currentUserId);
            return true;
        }
        return false;
    } catch (error) {
        console.error('âŒ Error initializing user from URL:', error);
        return false;
    }
}

// =============================================
// âœ… BASIC UI FUNCTIONS
// =============================================

/**
 * Show specific section and update active menu
 * @param {string} sectionId - ID of the section to show
 */
function showSection(sectionId) {
    try {
        // Hide all sections
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });

        // Remove active class from all menu items
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });

        // Show target section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
        }

        // Add active class to clicked menu item
        const menuItem = document.querySelector(`.menu-item[onclick="showSection('${sectionId}')"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }

        // Close sidebar on mobile after selection
        if (window.innerWidth <= 1024) {
            toggleSidebar(false);
        }

        console.log(`âœ… Switched to section: ${sectionId}`);

        // Load section-specific data
        switch(sectionId) {
            case 'dashboard':
                loadDashboardStats();
                break;
            case 'myBooks':
                loadBooksFromAPI();
                break;
            case 'addBook':
                // Handle add book
                break;
            case 'suggestions':  // âœ… ADD THIS CASE
                loadPublisherSuggestions();
                break;
            case 'analytics':
                // Handle analytics
                break;
            case 'profile':
                // Handle profile
                break;
        }
    } catch (error) {
        console.error('âŒ Error showing section:', error);
    }
}

/**
 * Show toast notification
 * @param {string} message - Message to display
 * @param {string} type - Type of toast (success, error, warning)
 */
function showToast(message, type = 'success') {
    try {
        const toast = document.getElementById('toast');
        if (toast) {
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }
    } catch (error) {
        console.error('âŒ Error showing toast:', error);
    }
}

/**
 * Show notification (alias for showToast)
 */
function showNotification(message, type = 'success') {
    showToast(message, type);
}

/**
 * Logout user and clear session
 */
function logout() {
    showLoading(true);
    try {
        localStorage.removeItem('currentPublisher');
        localStorage.removeItem('currentUserId');
        localStorage.removeItem('jwtToken');
        sessionStorage.removeItem('jwtToken');
        currentUserId = null;

        setTimeout(() => {
            showLoading(false);
            window.location.href = '/login';
        }, 1000);
    } catch (error) {
        console.error('âŒ Error during logout:', error);
        showLoading(false);
        window.location.href = '/login';
    }
}

/**
 * Close edit book modal
 */
function closeEditModal() {
    try {
        const editModal = document.getElementById('editBookModal');
        if (editModal) {
            editModal.style.display = 'none';
        }
    } catch (error) {
        console.error('âŒ Error closing edit modal:', error);
    }
}

/**
 * Toggle sidebar visibility (mobile)
 * @param {boolean} force - Force open/close state
 */
function toggleSidebar(force) {
    try {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            if (typeof force === 'boolean') {
                sidebar.classList.toggle('active', force);
            } else {
                sidebar.classList.toggle('active');
            }
        }
    } catch (error) {
        console.error('âŒ Error toggling sidebar:', error);
    }
}

/**
 * Show/hide global loading overlay
 * @param {boolean} show - Whether to show loading
 */
function showLoading(show) {
    try {
        const loadingOverlay = document.getElementById('globalLoading');
        if (loadingOverlay) {
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }
    } catch (error) {
        console.error('âŒ Error showing loading:', error);
    }
}

// =============================================
// âœ… AUTHENTICATION FUNCTIONS
// =============================================

/**
 * Get authentication token from storage
 * @returns {string|null} JWT token or null
 */
function getAuthToken() {
    try {
        return localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
    } catch (error) {
        console.error('âŒ Error getting auth token:', error);
        return null;
    }
}

/**
 * Enhanced fetch with authentication and error handling
 * @param {string} url - API endpoint
 * @param {Object} options - Fetch options
 * @returns {Promise<Response>} Fetch response
 */
async function authFetch(url, options = {}) {
    const token = getAuthToken();

    const headers = {
        ...options.headers
    };

    // Set content type only if not FormData
    if (!(options.body instanceof FormData) && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
    }

    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    try {
        const response = await fetch(url, {
            ...options,
            headers
        });

        // Handle authentication errors
        if (response.status === 401 || response.status === 403) {
            console.error('Access forbidden - check authentication');
            showToast('Session expired. Please login again.', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            throw new Error('Authentication failed');
        }

        return response;
    } catch (error) {
        console.error('âŒ Fetch error:', error);
        if (error.message !== 'Authentication failed') {
            showToast('Network error. Please check your connection.', 'error');
        }
        throw error;
    }
}

// =============================================
// âœ… DASHBOARD INITIALIZATION
// =============================================

/**
 * Initialize dashboard and validate authentication
 */
function initializeDashboard() {
    try {
        const token = getAuthToken();
        if (!token) {
            showToast('Please login to access publisher dashboard', 'error');
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }

        const savedPublisher = localStorage.getItem('currentPublisher');
        if (savedPublisher) {
            currentPublisher = JSON.parse(savedPublisher);
            const publisherNameElem = document.getElementById('publisherName');
            const publisherNameInput = document.getElementById('publisherNameInput');

            if (publisherNameElem) {
                publisherNameElem.textContent = `Welcome, ${currentPublisher.name}`;
            }
            if (publisherNameInput) {
                publisherNameInput.value = currentPublisher.name;
            }
        }

        console.log('âœ… Dashboard initialized successfully');
    } catch (error) {
        console.error('âŒ Error initializing dashboard:', error);
        showToast('Error initializing dashboard', 'error');
    }
}

/**
 * Set up event listeners for interactive elements
 */
function setupEventListeners() {
    try {
        // Upload area functionality
        const uploadArea = document.getElementById('uploadArea');
        const coverUpload = document.getElementById('coverUpload');

        if (uploadArea && coverUpload) {
            // Click to upload
            uploadArea.addEventListener('click', () => {
                coverUpload.click();
            });

            // File selection handler
            coverUpload.addEventListener('change', function(e) {
                handleCoverUpload(this.files);
            });

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleCoverUpload(files);
                }
            });
        }

        // Add book form submission
        const addBookForm = document.getElementById('addBookForm');
        if (addBookForm) {
            addBookForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addNewBook();
            });
        }

        // Modal close functionality
        window.addEventListener('click', function(event) {
            const bookModal = document.getElementById('bookModal');
            const editModal = document.getElementById('editBookModal');

            if (event.target === bookModal) {
                bookModal.style.display = 'none';
            }

            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
        });

        // Close buttons for modals
        const closeButtons = document.querySelectorAll('.close');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Escape key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditModal();
                closeModal('bookModal');
            }
        });

        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutOverlay = document.getElementById('logoutOverlay');
        const confirmLogout = document.getElementById('confirmLogout');
        const cancelLogout = document.getElementById('cancelLogout');

        if (logoutBtn && logoutOverlay && confirmLogout && cancelLogout) {
            logoutBtn.addEventListener('click', () => {
                logoutOverlay.style.display = 'flex';
            });

            cancelLogout.addEventListener('click', () => {
                logoutOverlay.style.display = 'none';
            });

            confirmLogout.addEventListener('click', () => {
                logoutOverlay.style.display = 'none';
                logout();
            });

            logoutOverlay.addEventListener('click', (e) => {
                if (e.target === logoutOverlay) {
                    logoutOverlay.style.display = 'none';
                }
            });
        }

        console.log('âœ… Event listeners setup completed');
    } catch (error) {
        console.error('âŒ Error setting up event listeners:', error);
    }
}

/**
 * Handle cover image upload and preview
 * @param {FileList} files - Selected files
 */
function handleCoverUpload(files) {
    try {
        if (files && files[0]) {
            const file = files[0];

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select a valid image file', 'error');
                return;
            }

            // Validate file size
            if (file.size > MAX_FILE_SIZE) {
                showToast('Image size must be less than 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('coverPreview');
                if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.onerror = function() {
                showToast('Error reading image file', 'error');
            };
            reader.readAsDataURL(file);
        }
    } catch (error) {
        console.error('âŒ Error handling cover upload:', error);
        showToast('Error uploading cover image', 'error');
    }
}

// =============================================
// âœ… CATEGORY MANAGEMENT FUNCTIONS
// =============================================

/**
 * Set default categories if API fails
 */
function setDefaultCategories() {
    try {
        categories = [
<!--            { id: 1, categoryName: "FICTION", description: "Fiction books" },-->
<!--            { id: 2, categoryName: "NON_FICTION", description: "Non-fiction books" },-->
<!--            { id: 3, categoryName: "SCIENCE_FICTION", description: "Sci-Fi books" },-->
<!--            { id: 4, categoryName: "MYSTERY", description: "Mystery books" },-->
<!--            { id: 5, categoryName: "BIOGRAPHY", description: "Biography books" }-->
        ];
        console.log('ðŸ”„ Using default categories:', categories.length);
        populateCategoryDropdowns();
    } catch (error) {
        console.error('âŒ Error setting default categories:', error);
    }
}

/**
 * Load categories from API
 */
async function loadCategories() {
    try {
        console.log('ðŸ”„ Loading categories from API...');
        const response = await authFetch(`${API_BASE_URL}/category/apies/findAll`);

        if (response.ok) {
            const categoriesData = await response.json();
            console.log('ðŸ“¥ Categories API Response:', categoriesData);

            if (categoriesData && categoriesData.length > 0) {
                categories = categoriesData;
                console.log('âœ… Categories loaded successfully:', categories.length);
            } else {
                console.log('âš ï¸ No categories found in API response, using defaults');
                setDefaultCategories();
                return;
            }
            populateCategoryDropdowns();
            updateCategoryFilters();
        } else {
            console.error('âŒ Categories API failed with status:', response.status);
            setDefaultCategories();
        }
    } catch (error) {
        console.error('âŒ Error loading categories:', error);
        setDefaultCategories();
    }
}

/**
 * Populate category dropdowns in forms and filters
 */
function populateCategoryDropdowns() {
    try {
        const addBookCategory = document.getElementById('bookCategory');
        const filterCategory = document.getElementById('categoryFilter');

        console.log('ðŸ”„ Populating category dropdowns...');
        console.log('Available categories:', categories);

        // Clear and populate Book Category dropdown
        if (addBookCategory) {
            while (addBookCategory.options.length > 1) {
                addBookCategory.remove(1);
            }

            categories.forEach(category => {
                const option = new Option(category.categoryName, category.id);
                addBookCategory.add(option);
            });

            console.log('âœ… Book category dropdown populated with', categories.length, 'categories');
        }

        // Clear and populate Filter Category dropdown
        if (filterCategory) {
            while (filterCategory.options.length > 1) {
                filterCategory.remove(1);
            }

            categories.forEach(category => {
                const option = new Option(category.categoryName, category.id);
                filterCategory.add(option);
            });

            console.log('âœ… Filter category dropdown populated');
        }
    } catch (error) {
        console.error('âŒ Error populating category dropdowns:', error);
    }
}

// =============================================
// âœ… BOOK MANAGEMENT FUNCTIONS
// =============================================

/**
 * Load books for current user from API
 */
async function loadBooksFromAPI() {
    showLoading(true);
    try {
        console.log('ðŸ“š Loading books for user ID:', currentUserId);

        if (!currentUserId) {
            throw new Error('User ID not available');
        }

        const response = await authFetch(`${API_BASE_URL}/book/apies/user/${currentUserId}`);

        if (response.ok) {
            const booksData = await response.json();
            books = booksData;

            // Debug: Check book categories
            console.log('ðŸ“¥ Books loaded:', books.length);
            books.forEach((book, index) => {
                console.log(`Book ${index + 1}:`, {
                    title: book.title,
                    category: book.category,
                    categoryId: book.category ? book.category.id : 'No category',
                    categoryName: book.category ? book.category.categoryName : 'No name'
                });
            });

            // Load reviews for all books
            await loadAllReviews();

            renderBooksTable();
            updateDashboardStats();
            loadRecentBooks();
            updateCategoryDistribution();
            updateCategoryFilters();

            showToast(`Loaded ${books.length} books successfully`, 'success');
        } else {
            const errorText = await response.text();
            throw new Error(errorText || `Failed to load books: ${response.status}`);
        }
    } catch (error) {
        console.error('âŒ Error loading books:', error);
        showToast('Failed to load books: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// =============================================
// âœ… REVIEW MANAGEMENT FUNCTIONS
// =============================================

/**
 * Load all reviews for user's books
 */
async function loadAllReviews() {
    try {
        console.log('ðŸ“ Loading all reviews...');
        allReviews = [];

        if (!books || books.length === 0) {
            console.log('No books available for loading reviews');
            return;
        }

        // Load reviews for each book
        for (const book of books) {
            try {
                const response = await authFetch(`${API_BASE_URL}/review/apies/book/${book.id}`);
                if (response.ok) {
                    const bookReviews = await response.json();
                    allReviews.push(...bookReviews.map(review => ({
                        ...review,
                        bookId: book.id
                    })));
                    console.log(`âœ… Loaded ${bookReviews.length} reviews for book ${book.id}`);
                }
            } catch (error) {
                console.error(`âŒ Error loading reviews for book ${book.id}:`, error);
            }
        }

        console.log(`âœ… Total reviews loaded: ${allReviews.length}`);
    } catch (error) {
        console.error('âŒ Error loading reviews:', error);
    }
}

/**
 * Get reviews for specific book
 * @param {number} bookId - Book ID
 * @returns {Array} Array of reviews
 */
function getBookReviews(bookId) {
    return allReviews.filter(review => review.bookId === bookId);
}

/**
 * Calculate rating statistics for a book
 * @param {number} bookId - Book ID
 * @returns {Object} Review count and average rating
 */
function calculateBookRatingStats(bookId) {
    const bookReviews = getBookReviews(bookId);
    const count = bookReviews.length;
    const averageRating = count > 0 ?
        bookReviews.reduce((sum, review) => sum + (review.rating || 0), 0) / count : 0;

    return {
        count,
        averageRating: parseFloat(averageRating.toFixed(1))
    };
}

/**
 * Update dashboard statistics
 */
function updateDashboardStats() {
    try {
        const totalBooks = books.length;
        const publishedBooks = books.filter(book =>
            book.status === 'published' || book.status === 'PUBLISHED' || book.status === 'APPROVED'
        ).length;
        const draftBooks = books.filter(book =>
            book.status === 'draft' || book.status === 'DRAFT' || book.status === 'PENDING' || !book.status
        ).length;

        const uniqueCategories = new Set();
        books.forEach(book => {
            if (book.category && book.category.id) {
                uniqueCategories.add(book.category.id);
            }
        });

        // Calculate total reviews and average rating across all books
        let totalReviews = 0;
        let totalRating = 0;
        let booksWithReviews = 0;

        books.forEach(book => {
            const stats = calculateBookRatingStats(book.id);
            if (stats.count > 0) {
                totalReviews += stats.count;
                totalRating += stats.averageRating;
                booksWithReviews++;
            }
        });

        const averageRating = booksWithReviews > 0 ? (totalRating / booksWithReviews) : 0;

        updateStats({
            totalBooks,
            publishedBooks,
            draftBooks,
            totalCategories: uniqueCategories.size,
            totalReviews,
            averageRating: parseFloat(averageRating.toFixed(1))
        });
    } catch (error) {
        console.error('âŒ Error updating dashboard stats:', error);
    }
}

    /**
     * Update statistics display
     * @param {Object} stats - Statistics object
     */
    function updateStats(stats) {
        try {
            const totalBooksElem = document.getElementById('totalBooks');
            const publishedBooksElem = document.getElementById('publishedBooks');
            const draftBooksElem = document.getElementById('draftBooks');
            const totalCategoriesElem = document.getElementById('totalCategories');
            const totalReviewsElem = document.getElementById('totalReviews');
            const averageRatingElem = document.getElementById('averageRating');

        if (totalBooksElem) totalBooksElem.textContent = stats.totalBooks;
        if (publishedBooksElem) publishedBooksElem.textContent = stats.publishedBooks;
        if (draftBooksElem) draftBooksElem.textContent = stats.draftBooks;
        if (totalCategoriesElem) totalCategoriesElem.textContent = stats.totalCategories;
        if (totalReviewsElem) totalReviewsElem.textContent = stats.totalReviews;
        if (averageRatingElem) averageRatingElem.textContent = stats.averageRating;
    } catch (error) {
        console.error('âŒ Error updating stats display:', error);
    }
}

/**
 * Load initial publisher data
 */
function loadPublisherData() {
    try {
        updateStats({
            totalBooks: 0,
            publishedBooks: 0,
            draftBooks: 0,
            totalCategories: 0,
            totalReviews: 0,
            averageRating: 0
        });
    } catch (error) {
        console.error('âŒ Error loading publisher data:', error);
    }
}

// =============================================
// âœ… RECENT BOOKS & CATEGORY DISTRIBUTION
// =============================================

/**
 * Load and display recent books
 */
function loadRecentBooks() {
    try {
        const recentBooksContainer = document.getElementById('recentBooks');
        if (!recentBooksContainer) return;

        const sortedBooks = [...books].sort((a, b) => {
            const dateA = new Date(a.uploadedAt || a.createdAt || 0);
            const dateB = new Date(b.uploadedAt || b.createdAt || 0);
            return dateB - dateA;
        });

        const recentBooks = sortedBooks.slice(0, 5);
        let html = '';

        if (recentBooks.length > 0) {
            recentBooks.forEach(book => {
                const statusClass = `status-${(book.status || 'draft').toLowerCase()}`;
                const date = book.uploadedAt || book.createdAt ?
                    new Date(book.uploadedAt || book.createdAt).toLocaleDateString() :
                    'Recent';

                const categoryName = book.category ?
                    (book.category.categoryName || book.category) :
                    'Uncategorized';

                // Get review stats for this book
                const reviewStats = calculateBookRatingStats(book.id);

                html += `
                    <div class="activity-item">
                        <div class="activity-info">
                            <h4>${book.title || 'Untitled'}</h4>
                            <div style="display: flex; gap: 8px; margin-top: 5px; flex-wrap: wrap;">
                                <span class="status-badge ${statusClass}">${book.status || 'draft'}</span>
                                <span class="category-badge">${categoryName}</span>
                                ${reviewStats.count > 0 ?
                                    `<span class="rating-display">
                                        <span class="review-rating">${generateStarRating(reviewStats.averageRating)}</span>
                                        <span class="rating-value">(${reviewStats.averageRating})</span>
                                    </span>` :
                                    '<span style="color: #888; font-size: 0.8rem;">No reviews</span>'
                                }
                            </div>
                        </div>
                        <span class="activity-time">${date}</span>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="activity-item">
                    <div class="activity-info">
                        <h4>No books found</h4>
                        <p>Add your first book to see it here!</p>
                    </div>
                </div>
            `;
        }

        recentBooksContainer.innerHTML = html;
    } catch (error) {
        console.error('âŒ Error loading recent books:', error);
    }
}

/**
 * Update category distribution display
 */
function updateCategoryDistribution() {
    try {
        const distributionContainer = document.getElementById('categoryDistribution');
        if (!distributionContainer) return;

        const categoryCounts = {};

        books.forEach(book => {
            let categoryName = 'Uncategorized';

            if (book.category) {
                categoryName = book.category.categoryName ||
                              (typeof book.category === 'string' ? book.category : 'Uncategorized');
            }

            categoryCounts[categoryName] = (categoryCounts[categoryName] || 0) + 1;
        });

        let html = '';

        if (Object.keys(categoryCounts).length > 0) {
            Object.entries(categoryCounts).forEach(([category, count]) => {
                const percentage = books.length > 0 ? ((count / books.length) * 100).toFixed(1) : 0;

                html += `
                    <div class="activity-item">
                        <div class="activity-info">
                            <h4>${category}</h4>
                            <span class="category-badge">${count} books</span>
                        </div>
                        <span class="activity-time">${percentage}%</span>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="activity-item">
                    <div class="activity-info">
                        <h4>No categories found</h4>
                        <p>Books will appear here once categories are assigned</p>
                    </div>
                </div>
            `;
        }

        distributionContainer.innerHTML = html;
    } catch (error) {
        console.error('âŒ Error updating category distribution:', error);
    }
}

/**
 * Update quick category filters
 */
function updateCategoryFilters() {
    try {
        const quickFilters = document.getElementById('quickCategoryFilters');
        if (!quickFilters) return;

        let html = '<div class="category-filter-btn active" onclick="filterBooksByCategory(\'\')">All</div>';

        const categoryCounts = {};
        books.forEach(book => {
            if (book.category && book.category.id) {
                categoryCounts[book.category.id] = (categoryCounts[book.category.id] || 0) + 1;
            }
        });

        const topCategories = Object.entries(categoryCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);

        topCategories.forEach(([categoryId, count]) => {
            const category = categories.find(c => c.id == categoryId);
            if (category) {
                html += `<div class="category-filter-btn" onclick="filterBooksByCategory(${categoryId})">
                          ${category.categoryName} (${count})
                         </div>`;
            }
        });

        quickFilters.innerHTML = html;
    } catch (error) {
        console.error('âŒ Error updating category filters:', error);
    }
}

// =============================================
// âœ… BOOK TABLE & DISPLAY FUNCTIONS
// =============================================

/**
 * Render books table with pagination
 * @param {Array} filteredBooks - Filtered books to display
 */
function renderBooksTable(filteredBooks = null) {
    try {
        const booksToRender = filteredBooks || books;
        const tableBody = document.getElementById('bookTableBody');
        const pagination = document.getElementById('bookPagination');

        if (!tableBody) return;

        if (!booksToRender || booksToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No books found</td></tr>';
            if (pagination) pagination.innerHTML = '';
            return;
        }

        // Calculate pagination
        const totalPages = Math.ceil(booksToRender.length / booksPerPage);
        const startIndex = (currentPage - 1) * booksPerPage;
        const endIndex = startIndex + booksPerPage;
        const booksToShow = booksToRender.slice(startIndex, endIndex);

        let html = '';
        booksToShow.forEach(book => {
            const statusClass = `status-${(book.status || 'draft').toLowerCase()}`;
            const date = book.uploadedAt || book.createdAt ?
                new Date(book.uploadedAt || book.createdAt).toLocaleDateString() :
                new Date().toLocaleDateString();

            const coverUrl = book.coverImagePath ?
                `${API_BASE_URL}/uploads/${book.coverImagePath}` :
                generatePlaceholderSvg(book.title);

            // Improved category handling
            let categoryName = 'Uncategorized';
            let categoryId = null;

            if (book.category) {
                categoryName = book.category.categoryName || 'Uncategorized';
                categoryId = book.category.id;
            } else if (book.categoryId) {
                const category = categories.find(cat => cat.id === book.categoryId);
                categoryName = category ? category.categoryName : `Category ${book.categoryId}`;
                categoryId = book.categoryId;
            }

            // Get review stats for this book
            const reviewStats = calculateBookRatingStats(book.id);

            html += `
                <tr>
                    <td class="book-cover-cell">
                        <img src="${coverUrl}" alt="${book.title}"
                             onerror="this.src='${generatePlaceholderSvg(book.title)}'">
                    </td>
                    <td>${book.title || 'Untitled'}</td>
                    <td>${book.author || 'Unknown Author'}</td>
                    <td><span class="category-badge">${categoryName}</span></td>
                    <td>
                        ${reviewStats.count > 0 ?
                            `<span class="review-count-badge">${reviewStats.count}</span>` :
                            '<span style="color: #888;">0</span>'
                        }
                    </td>
                    <td>
                        ${reviewStats.count > 0 ?
                            `<div class="rating-display">
                                <span class="review-rating">${generateStarRating(reviewStats.averageRating)}</span>
                                <span class="rating-value">${reviewStats.averageRating}</span>
                            </div>` :
                            '<span style="color: #888;">No rating</span>'
                        }
                    </td>
                    <td>${book.language || 'English'}</td>
                    <td><span class="status-badge ${statusClass}">${book.status || 'draft'}</span></td>
                    <td>${date}</td>
                    <td>
                        <div class="book-actions">
                            <button class="btn-primary btn-sm" onclick="viewBook(${book.id})">View</button>
                            <button class="btn-secondary btn-sm" onclick="editBook(${book.id})">Edit</button>
                            <button class="btn-danger btn-sm" onclick="deleteBook(${book.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tableBody.innerHTML = html;
        renderPagination(totalPages);
    } catch (error) {
        console.error('âŒ Error rendering books table:', error);
    }
}

/**
 * Render pagination controls
 * @param {number} totalPages - Total number of pages
 */
function renderPagination(totalPages) {
    try {
        const pagination = document.getElementById('bookPagination');
        if (!pagination) return;

        let html = '';

        // Previous button
        html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }

        // Next button
        html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

        pagination.innerHTML = html;
    } catch (error) {
        console.error('âŒ Error rendering pagination:', error);
    }
}

/**
 * Change current page
 * @param {number} page - Page number
 */
function changePage(page) {
    const totalPages = Math.ceil(books.length / booksPerPage);
    if (page < 1 || page > totalPages) return;

    currentPage = page;
    renderBooksTable();

    // Scroll to top of table
    const tableContainer = document.querySelector('.table-container');
    if (tableContainer) {
        tableContainer.scrollIntoView({ behavior: 'smooth' });
    }
}

/**
 * Generate placeholder SVG for book cover
 * @param {string} title - Book title
 * @returns {string} Data URL for SVG
 */
function generatePlaceholderSvg(title) {
    try {
        const initials = title ? title.charAt(0).toUpperCase() : 'B';
        const svg = `
            <svg width="50" height="65" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#4a90e2"/>
                <text x="50%" y="50%" font-family="Arial" font-size="20" fill="white"
                      text-anchor="middle" dy=".3em">${initials}</text>
            </svg>
        `;
        return 'data:image/svg+xml;base64,' + btoa(svg);
    } catch (error) {
        console.error('âŒ Error generating placeholder SVG:', error);
        return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNjUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzRhOTBlMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QjwvdGV4dD48L3N2Zz4=';
    }
}

// =============================================
// âœ… BOOK EVENT HANDLERS - BACKEND CRUD
// =============================================

/**
 * Validate book form data
 * @returns {boolean} Validation result
 */
function validateBookForm() {
    try {
        const title = document.getElementById('bookTitle').value.trim();
        const author = document.getElementById('bookAuthor').value.trim();
        const category = document.getElementById('bookCategory').value;
        const language = document.getElementById('bookLanguage').value.trim();
        const bookFile = document.getElementById('bookFile').files[0];

        if (!title || title.length < 2) {
            showToast('Please enter a valid book title (min 2 characters)', 'error');
            return false;
        }

        if (!author || author.length < 2) {
            showToast('Please enter a valid author name (min 2 characters)', 'error');
            return false;
        }

        if (!category) {
            showToast('Please select a category', 'error');
            return false;
        }

        if (!language) {
            showToast('Please enter a language', 'error');
            return false;
        }

        if (!bookFile) {
            showToast('Please select a book file', 'error');
            return false;
        }

        // Validate file type
        const allowedTypes = ['.pdf', '.txt'];
        const fileExtension = '.' + bookFile.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExtension)) {
            showToast('Please select a PDF or TXT file', 'error');
            return false;
        }

        // Validate file size
        if (bookFile.size > MAX_FILE_SIZE) {
            showToast('File size must be less than 10MB', 'error');
            return false;
        }

        return true;
    } catch (error) {
        console.error('âŒ Error validating book form:', error);
        showToast('Error validating form data', 'error');
        return false;
    }
}

/**
 * Add new book to the system
 */
async function addNewBook() {
    const submitBtn = document.getElementById('submitBookBtn');
    const spinner = document.getElementById('submitSpinner');

    try {
        // Validate form
        if (!validateBookForm()) {
            return;
        }

        submitBtn.disabled = true;
        if (spinner) spinner.style.display = 'inline-block';

        if (!currentUserId) {
            throw new Error('User ID not found. Please login again.');
        }

        const formData = new FormData();

        const bookData = {
            title: document.getElementById('bookTitle').value.trim(),
            author: document.getElementById('bookAuthor').value.trim(),
            description: document.getElementById('bookDescription').value.trim(),
            language: document.getElementById('bookLanguage').value.trim(),
            userId: currentUserId,
            categoryId: document.getElementById('bookCategory').value,
            status: "PENDING"
        };

        // âœ… CHECK IF THIS IS FOR A SUGGESTION
        const suggestionContext = sessionStorage.getItem('uploadForSuggestion');
        if (suggestionContext) {
            const context = JSON.parse(suggestionContext);
            bookData.suggestionId = context.suggestionId;
            console.log('ðŸ“š Uploading book for suggestion:', context.suggestionId);
        }

        console.log('ðŸ“¤ Sending book data for user:', currentUserId, 'Data:', bookData);

        formData.append('book', JSON.stringify(bookData));

        const pdfFile = document.getElementById('bookFile').files[0];
        const coverFile = document.getElementById('coverUpload').files[0];

        if (pdfFile) {
            formData.append('file', pdfFile);
        }
        if (coverFile) {
            formData.append('cover', coverFile);
        }

        const response = await authFetch(`${API_BASE_URL}/book/apies/upload`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || `Upload failed with status: ${response.status}`);
        }

        const result = await response.text();

        // âœ… HANDLE SUGGESTION COMPLETION
        if (suggestionContext) {
            const context = JSON.parse(suggestionContext);
            await markSuggestionAsUploaded(context.suggestionId);
            sessionStorage.removeItem('uploadForSuggestion');
            showToast('Book created and suggestion marked as fulfilled!', 'success');
        } else {
            showToast('Book created successfully!', 'success');
        }

        // Reset form
        resetBookForm();

        // Reload data and switch to appropriate section
        setTimeout(() => {
            loadBooksFromAPI();
            loadPublisherSuggestions(); // Refresh suggestions too
            showSection(suggestionContext ? 'suggestions' : 'myBooks');
        }, 1500);

    } catch (error) {
        console.error('âŒ Error creating book:', error);
        showToast('Failed to create book: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        if (spinner) spinner.style.display = 'none';
    }
}

/**
 * Mark suggestion as uploaded
 */
async function markSuggestionAsUploaded(suggestionId) {
    try {
        const response = await authFetch(`${SUGGESTION_API.UPLOAD_FOR_SUGGESTION}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                suggestionId: suggestionId,
                publisherId: currentUserId,
                uploadedAt: new Date().toISOString(),
                status: 'UPLOADED'
            })
        });

        if (response.ok) {
            console.log('âœ… Suggestion marked as uploaded:', suggestionId);
        }
    } catch (error) {
        console.error('âŒ Error marking suggestion as uploaded:', error);
    }
}

/**
 * Reset book form to initial state
 */
function resetBookForm() {
    try {
        document.getElementById('addBookForm').reset();
        const coverPreview = document.getElementById('coverPreview');
        if (coverPreview) {
            coverPreview.style.display = 'none';
            coverPreview.src = '';
        }
    } catch (error) {
        console.error('âŒ Error resetting book form:', error);
    }
}

/**
 * View book details in modal
 * @param {number} bookId - Book ID
 */
function viewBook(bookId) {
    try {
        const book = books.find(b => b.id === bookId);
        if (!book) {
            showToast('Book not found', 'error');
            return;
        }

        const modal = document.getElementById('bookModal');
        const bookDetails = document.getElementById('bookDetails');

        if (!modal || !bookDetails) return;

        const coverUrl = book.coverImagePath ?
            `${API_BASE_URL}/uploads/${book.coverImagePath}` :
            generatePlaceholderSvg(book.title);

        const date = new Date(book.uploadedAt || book.createdAt).toLocaleDateString();
        const categoryName = book.category ? book.category.categoryName : 'Uncategorized';

        bookDetails.innerHTML = `
            <div class="book-detail-view">
                <div class="book-cover-large">
                    <img src="${coverUrl}" alt="${book.title}"
                         onerror="this.src='${generatePlaceholderSvg(book.title)}'">
                </div>
                <div class="book-info">
                    <h3>${book.title}</h3>
                    <p><strong>Author:</strong> ${book.author}</p>
                    <p><strong>Category:</strong> <span class="category-badge">${categoryName}</span></p>
                    <p><strong>Language:</strong> ${book.language || 'English'}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${(book.status || 'draft').toLowerCase()}">${book.status || 'draft'}</span></p>
                    <p><strong>Date Added:</strong> ${date}</p>
                    <p><strong>Description:</strong> ${book.description || 'No description available.'}</p>
                    ${book.fileName ? `<p><strong>File:</strong> ${book.fileName}</p>` : ''}
                    ${book.fileSize ? `<p><strong>File Size:</strong> ${(book.fileSize / 1024 / 1024).toFixed(2)} MB</p>` : ''}
                    ${book.extractedText ? `<p><strong>Content Preview:</strong> ${book.extractedText.substring(0, 200)}...</p>` : ''}
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="reviews-section" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>ðŸ“ Reader Reviews</h3>
                <div id="reviewsContent-${book.id}">
                    <p>Loading reviews...</p>
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-primary" onclick="closeModal('bookModal')">Close</button>
            </div>
        `;

        modal.style.display = 'block';

        // Load reviews for this book
        loadBookReviewsForModal(book.id);
    } catch (error) {
        console.error('âŒ Error viewing book:', error);
        showToast('Error loading book details', 'error');
    }
}

/**
 * Edit book details
 * @param {number} bookId - Book ID
 */
function editBook(bookId) {
    try {
        const book = books.find(b => b.id === bookId);
        if (!book) {
            showToast('Book not found', 'error');
            return;
        }

        const modal = document.getElementById('editBookModal');
        const editForm = document.getElementById('editBookForm');

        if (!modal || !editForm) return;

        let categoryOptions = '';
        categories.forEach(category => {
            const selected = book.category && book.category.id === category.id ? 'selected' : '';
            categoryOptions += `<option value="${category.id}" ${selected}>${category.categoryName}</option>`;
        });

        editForm.innerHTML = `
            <input type="hidden" id="editBookId" value="${book.id}">
            <div class="form-row">
                <div class="form-group">
                    <label for="editBookTitle">Book Title *</label>
                    <input type="text" id="editBookTitle" value="${book.title || ''}" required>
                </div>
                <div class="form-group">
                    <label for="editBookAuthor">Author *</label>
                    <input type="text" id="editBookAuthor" value="${book.author || ''}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editBookCategory">Category</label>
                    <select id="editBookCategory">
                        <option value="">Select Category</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="editBookLanguage">Language *</label>
                    <input type="text" id="editBookLanguage" value="${book.language || 'English'}" required>
                </div>
            </div>

            <div class="form-group">
                <label for="editBookDescription">Description</label>
                <textarea id="editBookDescription" rows="4">${book.description || ''}</textarea>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-primary">Update Book</button>
            </div>
        `;

        modal.style.display = 'block';

        editForm.onsubmit = async function(e) {
            e.preventDefault();
            await updateBook(bookId);
        };
    } catch (error) {
        console.error('âŒ Error editing book:', error);
        showToast('Error loading edit form', 'error');
    }
}

/**
 * Update book details
 * @param {number} bookId - Book ID
 */
async function updateBook(bookId) {
    showLoading(true);
    try {
        if (!currentUserId) {
            throw new Error('User ID not found. Please login again.');
        }

        const bookData = {
            title: document.getElementById('editBookTitle').value.trim(),
            author: document.getElementById('editBookAuthor').value.trim(),
            description: document.getElementById('editBookDescription').value.trim(),
            language: document.getElementById('editBookLanguage').value.trim(),
            userId: currentUserId,
            categoryId: document.getElementById('editBookCategory').value || null
        };

        // Validate required fields
        if (!bookData.title || !bookData.author || !bookData.language) {
            throw new Error('Please fill in all required fields');
        }

        const response = await authFetch(`${API_BASE_URL}/book/apies/Update/${bookId}`, {
            method: 'PUT',
            body: JSON.stringify(bookData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to update book');
        }

        const result = await response.text();
        showToast('Book updated successfully!', 'success');

        await loadBooksFromAPI();
        closeEditModal();

    } catch (error) {
        console.error('âŒ Error updating book:', error);
        showToast('Failed to update book: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Delete book with confirmation
 * @param {number} bookId - Book ID
 */
async function deleteBook(bookId) {
    if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
        showLoading(true);
        try {
            const response = await authFetch(`${API_BASE_URL}/book/apies/delete/${bookId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to delete book');
            }

            const result = await response.text();
            showToast('Book deleted successfully!', 'success');

            await loadBooksFromAPI();

        } catch (error) {
            console.error('âŒ Error deleting book:', error);
            showToast('Failed to delete book: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }
}

/**
 * Close modal by ID
 * @param {string} modalId - Modal element ID
 */
function closeModal(modalId) {
    try {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    } catch (error) {
        console.error('âŒ Error closing modal:', error);
    }
}

// =============================================
// âœ… REVIEW MANAGEMENT FUNCTIONS
// =============================================

/**
 * Load reviews for specific book and display in modal
 * @param {number} bookId - Book ID
 */
async function loadBookReviewsForModal(bookId) {
    try {
        console.log(`ðŸ“ Loading reviews for book ${bookId}...`);

        const response = await authFetch(`${API_BASE_URL}/review/apies/book/${bookId}`);
        const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);

        if (!reviewsContent) return;

        if (response.ok) {
            const reviews = await response.json();
            console.log(`âœ… Loaded ${reviews.length} reviews for book ${bookId}`);
            displayReviewsInModal(bookId, reviews);
        } else {
            reviewsContent.innerHTML = `
                <div class="no-reviews">
                    <p>âŒ Failed to load reviews. Please try again.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error(`âŒ Error loading reviews for book ${bookId}:`, error);
        const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);
        if (reviewsContent) {
            reviewsContent.innerHTML = `
                <div class="no-reviews">
                    <p>âŒ Error loading reviews: ${error.message}</p>
                </div>
            `;
        }
    }
}

/**
 * Display reviews in modal
 * @param {number} bookId - Book ID
 * @param {Array} reviews - Array of reviews
 */
function displayReviewsInModal(bookId, reviews) {
    try {
        const reviewsContent = document.getElementById(`reviewsContent-${bookId}`);
        if (!reviewsContent) return;

        if (!reviews || reviews.length === 0) {
            reviewsContent.innerHTML = `
                <div class="no-reviews">
                    <p>ðŸ“­ No reviews yet. Be the first to review this book!</p>
                </div>
            `;
            return;
        }

        // Calculate average rating
        const averageRating = calculateAverageRating(reviews);
        const totalReviews = reviews.length;

        let html = `
            <div class="reviews-summary">
                <div class="average-rating">
                    <div class="rating-stars-large">${generateStarRating(averageRating)}</div>
                    <div class="rating-details">
                        <strong>${averageRating.toFixed(1)}</strong> out of 5
                        <span class="review-count">(${totalReviews} ${totalReviews === 1 ? 'review' : 'reviews'})</span>
                    </div>
                </div>
            </div>

            <div class="reviews-list" style="margin-top: 20px;">
                <h4>Recent Reviews</h4>
        `;

        // Show latest 5 reviews
        const recentReviews = reviews
            .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date))
            .slice(0, 5);

        recentReviews.forEach(review => {
            const reviewDate = new Date(review.createdAt || review.date).toLocaleDateString();
            const userName = review.user ? (review.user.name || review.user.username) : 'Anonymous User';

            html += `
                <div class="review-item">
                    <div class="review-header">
                        <div>
                            <strong>${userName}</strong>
                            <div class="review-rating">${generateStarRating(review.rating)}</div>
                        </div>
                        <span class="review-date">${reviewDate}</span>
                    </div>
                    <div class="review-text">
                        ${review.reviewText || review.comment || 'No review text provided.'}
                    </div>
                </div>
            `;
        });

        if (reviews.length > 5) {
            html += `
                <div style="text-align: center; margin-top: 15px;">
                    <small>+ ${reviews.length - 5} more reviews</small>
                </div>
            `;
        }

        html += `</div>`;
        reviewsContent.innerHTML = html;
    } catch (error) {
        console.error('âŒ Error displaying reviews:', error);
    }
}

/**
 * Calculate average rating from reviews
 * @param {Array} reviews - Array of reviews
 * @returns {number} Average rating
 */
function calculateAverageRating(reviews) {
    if (!reviews || reviews.length === 0) return 0;
    const total = reviews.reduce((sum, review) => sum + (review.rating || 0), 0);
    return total / reviews.length;
}

/**
 * Generate star rating display
 * @param {number} rating - Rating value (0-5)
 * @returns {string} Star rating string
 */
function generateStarRating(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    return 'â­'.repeat(fullStars) +
           (hasHalfStar ? 'â­' : '') +
           'â˜†'.repeat(emptyStars);
}

// =============================================
// âœ… SEARCH & FILTER FUNCTIONS
// =============================================

/**
 * Search books by title, author, or category
 */
function searchBooks() {
    try {
        const searchTerm = document.getElementById('bookSearch').value.toLowerCase().trim();
        if (!searchTerm) {
            renderBooksTable();
            return;
        }

        const filteredBooks = books.filter(book =>
            (book.title && book.title.toLowerCase().includes(searchTerm)) ||
            (book.author && book.author.toLowerCase().includes(searchTerm)) ||
            (book.category &&
             ((book.category.categoryName && book.category.categoryName.toLowerCase().includes(searchTerm)) ||
              (typeof book.category === 'string' && book.category.toLowerCase().includes(searchTerm))))
        );

        currentPage = 1; // Reset to first page when searching
        renderBooksTable(filteredBooks);

        if (filteredBooks.length === 0) {
            showToast('No books found matching your search', 'warning');
        }
    } catch (error) {
        console.error('âŒ Error searching books:', error);
    }
}

/**
 * Filter books by status and category
 */
function filterBooks() {
    try {
        const status = document.getElementById('statusFilter').value;
        const category = document.getElementById('categoryFilter').value;

        let filteredBooks = books;

        if (status) {
            filteredBooks = filteredBooks.filter(book =>
                book.status && book.status.toLowerCase() === status.toLowerCase()
            );
        }

        if (category) {
            filteredBooks = filteredBooks.filter(book =>
                book.category && book.category.id == category
            );
        }

        currentPage = 1; // Reset to first page when filtering
        renderBooksTable(filteredBooks);
    } catch (error) {
        console.error('âŒ Error filtering books:', error);
    }
}

/**
 * Filter books by category using quick filters
 * @param {string} categoryId - Category ID
 */
function filterBooksByCategory(categoryId) {
    try {
        // Update active state of filter buttons
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        event.target.classList.add('active');

        if (!categoryId) {
            renderBooksTable();
            return;
        }

        const filteredBooks = books.filter(book =>
            book.category && book.category.id == categoryId
        );

        currentPage = 1; // Reset to first page when filtering
        renderBooksTable(filteredBooks);
    } catch (error) {
        console.error('âŒ Error filtering books by category:', error);
    }
}

// =============================================
// âœ… PROFILE MANAGEMENT
// =============================================

/**
 * Update publisher profile
 */
function updateProfile() {
    try {
        const name = document.getElementById('publisherNameInput').value.trim();
        const email = document.getElementById('publisherEmail').value.trim();
        const phone = document.getElementById('publisherPhone').value.trim();
        const company = document.getElementById('companyName').value.trim();
        const address = document.getElementById('companyAddress').value.trim();
        const website = document.getElementById('companyWebsite').value.trim();

        // Basic validation
        if (!name) {
            showToast('Please enter a publisher name', 'error');
            return;
        }

        if (email && !isValidEmail(email)) {
            showToast('Please enter a valid email address', 'error');
            return;
        }

        const publisherNameElem = document.getElementById('publisherName');
        if (publisherNameElem) {
            publisherNameElem.textContent = `Welcome, ${name}`;
        }

        if (currentPublisher) {
            currentPublisher.name = name;
            localStorage.setItem('currentPublisher', JSON.stringify(currentPublisher));
        }

        showToast('Profile updated successfully!', 'success');
    } catch (error) {
        console.error('âŒ Error updating profile:', error);
        showToast('Error updating profile', 'error');
    }
}

/**
 * Validate email format
 * @param {string} email - Email to validate
 * @returns {boolean} Validation result
 */
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// =============================================
// âœ… PUBLISHER SUGGESTION FUNCTIONS
// =============================================

/**
 * Load suggestions for publishers from LIVE API
 */
async function loadPublisherSuggestions() {
    showLoading(true);
    try {
        console.log('ðŸ“¥ Loading LIVE suggestions for publisher...', currentUserId);

        const suggestionTableBody = document.getElementById('suggestionTableBody');
        if (suggestionTableBody) {
            suggestionTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading-cell">
                        <div class="loading-spinner"></div>
                        Loading live suggestions from users...
                    </td>
                </tr>
            `;
        }

        // âœ… LIVE API CALL - Publisher-specific suggestions
        const response = await authFetch(`${SUGGESTION_API.GET_BY_PUBLISHER}/${currentUserId}`);

        if (response.ok) {
            const data = await response.json();
            console.log('âœ… LIVE Suggestions loaded:', data);

            // Data structure assume karte hain: { suggestions: [], stats: {} }
            const suggestions = data.suggestions || data || [];

            displayPublisherSuggestions(suggestions);
            updatePublisherSuggestionStats(suggestions);

            showToast(`Loaded ${suggestions.length} live suggestions`, 'success');
        } else {
    console.error('âŒ Failed to load LIVE suggestions:', response.status);

    // Show user-friendly error
    const suggestionTableBody = document.getElementById('suggestionTableBody');
    if (suggestionTableBody) {
        suggestionTableBody.innerHTML = `
            <tr>
                <td colspan="8" class="no-data">
                    <i class='bx bx-error'></i>
                    <p>Suggestions API temporarily unavailable</p>
                    <p>Please try again later</p>
                </td>
            </tr>
        `;
    }

    // Reset stats
    updatePublisherSuggestionStats([]);
}

    } catch (error) {
        console.error('âŒ Error loading LIVE publisher suggestions:', error);
        showNotification('Failed to load live suggestions. Please try again.', 'error');

        // Final fallback: Show empty state
        const suggestionTableBody = document.getElementById('suggestionTableBody');
        if (suggestionTableBody) {
            suggestionTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="no-data">
                        <i class='bx bx-bulb'></i>
                        <p>Unable to load suggestions</p>
                        <p>Please check your connection and try again</p>
                    </td>
                </tr>
            `;
        }
    } finally {
        showLoading(false);
    }
}

/**
 * Load all suggestions (fallback method)
 */
async function loadAllSuggestions() {
    console.log('ðŸ”„ Using empty suggestions as fallback...');

    const suggestionTableBody = document.getElementById('suggestionTableBody');
    if (suggestionTableBody) {
        suggestionTableBody.innerHTML = `
            <tr>
                <td colspan="8" class="no-data">
                    <i class='bx bx-bulb'></i>
                    <p>No suggestions available yet</p>
                    <p>Check back later for user suggestions</p>
                </td>
            </tr>
        `;
    }

    updatePublisherSuggestionStats([]);
    return Promise.resolve(); // Return resolved promise
}

/**
 * Display suggestions in publisher dashboard
 */
function displayPublisherSuggestions(suggestions) {
    const suggestionTableBody = document.getElementById('suggestionTableBody');
    if (!suggestionTableBody) return;

    if (!suggestions || suggestions.length === 0) {
        suggestionTableBody.innerHTML = `
            <tr>
                <td colspan="8" class="no-data">
                    <i class='bx bx-bulb'></i>
                    <p>No suggestions available</p>
                    <p>User suggestions will appear here</p>
                </td>
            </tr>
        `;
        return;
    }

    suggestionTableBody.innerHTML = suggestions.map(suggestion => `
        <tr>
            <td>
                <div class="book-title">
                    <strong>${suggestion.suggestedTitle || 'Untitled'}</strong>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">
                        by ${suggestion.author || 'Unknown Author'}
                    </div>
                </div>
            </td>
            <td>
                <div class="user-avatar">
                    <i class='bx bx-user'></i>
                    <span>${suggestion.suggestedByUserName || 'Anonymous User'}</span>
                </div>
            </td>
            <td>
                <div class="suggestion-reason">
                    ${suggestion.suggestionReason || 'No reason provided'}
                </div>
            </td>
            <td>
                <span class="upvote-count">${suggestion.totalUpvotes || 0} ðŸ‘</span>
            </td>
            <td>
                <span class="interest-count">${suggestion.totalPublisherInterests || 0} ðŸ‘ï¸</span>
            </td>
            <td>
                ${getPublisherActionBadge(suggestion)}
            </td>
            <td>${formatDate(suggestion.suggestionCreatedAt)}</td>
            <td>
                <div class="book-actions">
                    ${!suggestion.publisherAction || suggestion.publisherAction === 'NOT_INTERESTED' ? `
                        <button class="btn-success btn-sm" onclick="expressInterest(${suggestion.suggestionId})" title="Express Interest">
                            <i class='bx bx-show'></i> Interested
                        </button>
                    ` : ''}

                    ${suggestion.publisherAction === 'INTERESTED' ? `
                        <button class="btn-primary btn-sm" onclick="uploadForSuggestion(${suggestion.suggestionId})" title="Upload Book">
                            <i class='bx bx-upload'></i> Upload
                        </button>
                    ` : ''}

                    <button class="btn-info btn-sm" onclick="viewSuggestionDetails(${suggestion.suggestionId})" title="View Details">
                        <i class='bx bx-show'></i> Details
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

/**
 * Get publisher action badge
 */
function getPublisherActionBadge(suggestion) {
    if (!suggestion.publisherAction || suggestion.publisherAction === 'NOT_INTERESTED') {
        return '<span class="status-badge status-pending">Not Viewed</span>';
    }

    switch(suggestion.publisherAction) {
        case 'INTERESTED':
            return '<span class="status-badge status-approved">Interested</span>';
        case 'UPLOADED':
            return '<span class="status-badge status-success">Uploaded</span>';
        default:
            return '<span class="status-badge status-pending">Pending</span>';
    }
}

/**
 * Update publisher suggestion statistics
 */
function updatePublisherSuggestionStats(suggestions) {
    const total = suggestions.length;
    const interested = suggestions.filter(s => s.publisherAction === 'INTERESTED').length;
    const uploaded = suggestions.filter(s => s.publisherAction === 'UPLOADED').length;

    document.getElementById('totalPublisherSuggestions').textContent = total;
    document.getElementById('interestedPublisherSuggestions').textContent = interested;
    document.getElementById('uploadedPublisherSuggestions').textContent = uploaded;
}

/**
 * Express interest in a suggestion - LIVE API
 */
async function expressInterest(suggestionId) {
    if (!confirm('Are you interested in publishing this book? The user will be notified.')) {
        return;
    }

    showLoading(true);
    try {
        console.log('ðŸŽ¯ Expressing interest in suggestion:', suggestionId, 'by publisher:', currentUserId);

        // âœ… FIXED: Proper request object banao
        const requestData = {
            publisherId: currentUserId,
            suggestionId: suggestionId,
            notes: 'Interested in publishing this book'
        };

        console.log('ðŸ“¤ Sending interest request:', requestData);

        // âœ… LIVE API CALL - FIXED
        const response = await authFetch(`${SUGGESTION_API.EXPRESS_INTEREST}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (response.ok) {
            const result = await response.json();
            console.log('âœ… Interest expressed successfully:', result);

            showNotification('Interest expressed successfully! User has been notified.', 'success');

            // âœ… REAL-TIME UPDATE
            setTimeout(() => {
                loadPublisherSuggestions();
            }, 1000);

        } else {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to express interest');
        }

    } catch (error) {
        console.error('âŒ Error expressing interest:', error);
        showNotification('Error expressing interest: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Upload book for a suggestion - LIVE API Integration
 */
async function uploadForSuggestion(suggestionId) {
    try {
        // âœ… Store suggestion context for the upload form
        const suggestionContext = {
            suggestionId: suggestionId,
            timestamp: new Date().toISOString(),
            publisherId: currentUserId
        };

        sessionStorage.setItem('uploadForSuggestion', JSON.stringify(suggestionContext));

        showNotification('Redirecting to upload form...', 'info');

        // Switch to add book section
        showSection('addBook');

        // âœ… Optional: Pre-fill form with suggestion data
        setTimeout(() => {
            prefillBookFormWithSuggestion(suggestionId);
        }, 500);

    } catch (error) {
        console.error('âŒ Error preparing upload for suggestion:', error);
        showNotification('Error preparing upload form', 'error');
    }
}

/**
 * Pre-fill book form with suggestion data
 */
async function prefillBookFormWithSuggestion(suggestionId) {
    try {
        // âœ… Get suggestion details to pre-fill form
        const response = await authFetch(`${SUGGESTION_API.GET_DETAILS}/${suggestionId}`);

        if (response.ok) {
            const suggestion = await response.json();

            // Pre-fill form fields if available
            if (suggestion.suggestedTitle) {
                document.getElementById('bookTitle').value = suggestion.suggestedTitle;
            }
            if (suggestion.author) {
                document.getElementById('bookAuthor').value = suggestion.author;
            }
            if (suggestion.suggestionReason) {
                document.getElementById('bookDescription').value = `Based on user suggestion: ${suggestion.suggestionReason}`;
            }

            showToast('Form pre-filled with suggestion details', 'info');
        }
    } catch (error) {
        console.log('Could not pre-fill form, continuing normally...');
    }
}

/**
 * View suggestion details - LIVE API
 */
/**
 * View suggestion details - LIVE API - FIXED
 */
async function viewSuggestionDetails(suggestionId) {
    showLoading(true);
    try {
        console.log('ðŸ” Viewing suggestion details:', suggestionId);

        // âœ… FIXED: Ensure suggestionId is valid number
        if (!suggestionId || isNaN(suggestionId)) {
            throw new Error('Invalid suggestion ID');
        }

        // âœ… FIXED: Proper URL with number
        const response = await authFetch(`${SUGGESTION_API.GET_DETAILS}/${suggestionId}`);

        if (response.ok) {
            const result = await response.json();
            console.log('âœ… Suggestion details loaded:', result);

            if (result.success && result.suggestion) {
                showSuggestionDetailsModal(result.suggestion);
            } else {
                throw new Error(result.message || 'Failed to load suggestion details');
            }
        } else {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to load suggestion details');
        }

    } catch (error) {
        console.error('âŒ Error loading suggestion details:', error);
        showNotification('Error loading suggestion details: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

/**
 * Show suggestion details modal
 */
function showSuggestionDetailsModal(suggestion) {
    // Create and show a modal with suggestion details
    const modalHtml = `
        <div class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Suggestion Details</h2>
                <div class="suggestion-details">
                    <h3>${suggestion.suggestedTitle}</h3>
                    <p><strong>Author:</strong> ${suggestion.author}</p>
                    <p><strong>Suggested by:</strong> ${suggestion.userName}</p>
                    <p><strong>Reason:</strong> ${suggestion.suggestionReason}</p>
                    <p><strong>Upvotes:</strong> ${suggestion.upvoteCount || 0}</p>
                    <p><strong>Publisher Interest:</strong> ${suggestion.publisherInterestCount || 0}</p>
                    <p><strong>Date Suggested:</strong> ${formatDate(suggestion.createdAt)}</p>
                </div>
                <div class="modal-actions">
                    <button class="btn-primary" onclick="expressInterest(${suggestion.id})">Express Interest</button>
                    <button class="btn-secondary" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Search publisher suggestions - LIVE/CLIENT-SIDE
 */
function searchPublisherSuggestions() {
    const searchTerm = document.getElementById('suggestionSearch').value.toLowerCase().trim();

    if (!searchTerm) {
        // If search is empty, reload original data
        loadPublisherSuggestions();
        return;
    }

    // Client-side filtering for better UX
    const allRows = document.querySelectorAll('#suggestionTableBody tr');
    let hasResults = false;

    allRows.forEach(row => {
        const titleText = row.cells[0]?.textContent?.toLowerCase() || '';
        const authorText = row.cells[0]?.querySelector('.book-title div')?.textContent?.toLowerCase() || '';
        const userText = row.cells[1]?.textContent?.toLowerCase() || '';
        const reasonText = row.cells[2]?.textContent?.toLowerCase() || '';

        const matches = titleText.includes(searchTerm) ||
                       authorText.includes(searchTerm) ||
                       userText.includes(searchTerm) ||
                       reasonText.includes(searchTerm);

        row.style.display = matches ? '' : 'none';
        if (matches) hasResults = true;
    });

    // Show no results message if needed
    if (!hasResults) {
        showNotification('No suggestions found matching your search', 'warning');
    }
}

/**
 * Filter publisher suggestions - LIVE/CLIENT-SIDE
 */
function filterPublisherSuggestions() {
    const filterValue = document.getElementById('suggestionFilter').value;

    const allRows = document.querySelectorAll('#suggestionTableBody tr');

    allRows.forEach(row => {
        if (row.classList.contains('loading-cell') || row.classList.contains('no-data')) {
            return;
        }

        const actionBadge = row.cells[5]?.querySelector('.status-badge')?.textContent?.toLowerCase() || '';

        let shouldShow = true;

        switch(filterValue) {
            case 'interested':
                shouldShow = actionBadge.includes('interested');
                break;
            case 'uploaded':
                shouldShow = actionBadge.includes('uploaded');
                break;
            case 'trending':
                // Show suggestions with high upvotes
                const upvotes = parseInt(row.cells[3]?.textContent) || 0;
                shouldShow = upvotes > 20;
                break;
            case 'all':
            default:
                shouldShow = true;
        }

        row.style.display = shouldShow ? '' : 'none';
    });
}

/**
 * Format date for display
 */
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

// =============================================
// âœ… AUTO-REFRESH & REAL-TIME UPDATES
// =============================================

let suggestionsRefreshInterval = null;

/**
 * Start auto-refresh for suggestions
 */
function startSuggestionsAutoRefresh() {
    // Clear existing interval
    if (suggestionsRefreshInterval) {
        clearInterval(suggestionsRefreshInterval);
    }

    // Refresh every 2 minutes
    suggestionsRefreshInterval = setInterval(() => {
        if (isSuggestionsSectionActive()) {
            console.log('ðŸ”„ Auto-refreshing suggestions...');
            loadPublisherSuggestions();
        }
    }, 2 * 60 * 1000); // 2 minutes

    console.log('âœ… Suggestions auto-refresh started');
}

/**
 * Check if suggestions section is active
 */
function isSuggestionsSectionActive() {
    const suggestionsSection = document.getElementById('suggestions');
    return suggestionsSection && suggestionsSection.classList.contains('active');
}

/**
 * Stop auto-refresh
 */
function stopSuggestionsAutoRefresh() {
    if (suggestionsRefreshInterval) {
        clearInterval(suggestionsRefreshInterval);
        suggestionsRefreshInterval = null;
        console.log('âœ… Suggestions auto-refresh stopped');
    }
}

/**
 * Manual refresh function
 */
function refreshSuggestions() {
    showLoading(true);
    loadPublisherSuggestions()
        .finally(() => {
            setTimeout(() => showLoading(false), 500);
        });
}

// =============================================
// âœ… PAGE INITIALIZATION
// =============================================

/**
 * Initialize the application when DOM is loaded
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing dashboard...');

    try {
        // Initialize user session
        if (!initializeUserFromURL()) {
            if (!initializeUser()) {
                return;
            }
        }

        // Initialize dashboard components
        initializeDashboard();
        setupEventListeners();
        loadPublisherData();
        loadCategories();
        loadBooksFromAPI();

        // âœ… START AUTO-REFRESH
        startSuggestionsAutoRefresh();

        // Set favicon if not present
        const favicon = document.querySelector('link[rel="icon"]');
        if (!favicon) {
            const newFavicon = document.createElement('link');
            newFavicon.rel = 'icon';
            newFavicon.href = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>';
            document.head.appendChild(newFavicon);
        }

        console.log('âœ… Application initialized successfully with LIVE data');
    } catch (error) {
        console.error('âŒ Error initializing application:', error);
        showToast('Error initializing application', 'error');
    }
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showToast('An unexpected error occurred', 'error');
});

// Handle page unload
window.addEventListener('beforeunload', function() {
    showLoading(false);
    stopSuggestionsAutoRefresh(); // âœ… CLEANUP AUTO-REFRESH
});
</script>

</body>
</html>