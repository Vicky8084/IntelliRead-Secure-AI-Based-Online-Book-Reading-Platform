<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - Intelli-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Chakra Petch", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .book-title {
            font-size: 1.3rem;
            color: #333;
            text-align: center;
            flex: 1;
        }

        .reader-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .reader-container {
            display: flex;
            height: calc(100vh - 70px);
            padding: 20px;
            gap: 20px;
        }

        .pdf-viewer {
            flex: 7;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pdf-frame-container {
            flex: 1;
            position: relative;
        }

        #pdfFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .ai-sidebar {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .ai-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .ai-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .ai-section h3 i {
            color: #667eea;
        }

        .chapter-summary {
            line-height: 1.6;
            color: #555;
            font-size: 0.95rem;
        }

        .key-points {
            list-style: none;
            margin-top: 10px;
        }

        .key-points li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-points li:before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .question-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #questionInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        #questionInput:focus {
            border-color: #667eea;
        }

        .ask-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .ask-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-answer {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
            display: none;
        }

        .ai-answer.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .reading-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI Status Indicator */
        .ai-status {
            margin-right: 15px;
        }

        .ai-status span {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ai-online {
            background: #28a745;
            color: white;
        }

        .ai-demo {
            background: #ffc107;
            color: #856404;
        }

        .ai-offline {
            background: #dc3545;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .reader-container {
                flex-direction: column;
                height: auto;
            }

            .pdf-viewer {
                height: 70vh;
            }

            .ai-sidebar {
                height: auto;
            }
        }
    </style>
</head>
<body>
<!-- Header -->
<div class="reader-header">
    <div class="logo">Intelli-Read</div>
    <div class="book-title" id="bookTitle">Loading Book...</div>

    <!-- AI Status Indicator -->
    <div class="ai-status" id="aiStatus">
            <span class="ai-online">
                <i class='bx bx-chip'></i> AI Online
            </span>
    </div>

    <div class="reader-controls">
        <button class="control-btn" onclick="saveProgress()">
            <i class='bx bx-bookmark'></i> Save Progress
        </button>
        <button class="control-btn" onclick="closeReader()">
            <i class='bx bx-x'></i> Close
        </button>
    </div>
</div>

<!-- Main Reader Container -->
<div class="reader-container">
    <!-- PDF Viewer -->
    <div class="pdf-viewer">
        <div class="pdf-frame-container">
            <iframe id="pdfFrame" width="100%" height="100%"></iframe>
        </div>
        <div class="pdf-controls">
            <div class="page-nav">
                <button class="nav-btn" onclick="previousPage()" id="prevBtn">
                    <i class='bx bx-chevron-left'></i>
                </button>
                <span id="pageInfo">Page 1 of 1</span>
                <button class="nav-btn" onclick="nextPage()" id="nextBtn">
                    <i class='bx bx-chevron-right'></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Sidebar -->
    <div class="ai-sidebar">
        <!-- Book Info Section -->
        <div class="ai-section">
            <h3><i class='bx bx-book'></i> Book Information</h3>
            <div id="bookInfo">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading book info...
                </div>
            </div>
        </div>

        <!-- AI Summary Section -->
        <div class="ai-section">
            <h3><i class='bx bx-brain'></i> AI Chapter Summary</h3>
            <div id="chapterSummary">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Generating AI summary...
                </div>
            </div>
        </div>

        <!-- Key Points Section -->
        <div class="ai-section">
            <h3><i class='bx bx-star'></i> Key Points</h3>
            <ul class="key-points" id="keyPoints">
                <li>Loading key points...</li>
            </ul>
        </div>

        <!-- Q&A Section -->
        <div class="ai-section">
            <h3><i class='bx bx-message-rounded'></i> Ask AI Assistant</h3>
            <div class="question-input-container">
                <input type="text" id="questionInput" placeholder="Ask anything about this book...">
                <button class="ask-btn" onclick="askAIQuestion()">Ask</button>
            </div>
            <div class="ai-answer" id="aiAnswer">
                <!-- AI answers will appear here -->
            </div>
        </div>

        <!-- Reading Analytics -->
        <div class="ai-section">
            <h3><i class='bx bx-stats'></i> Reading Analytics</h3>
            <div class="reading-stats" id="readingStats">
                <div class="stat-item">
                    <div class="stat-value" id="timeSpent">0m</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pagesRead">0</div>
                    <div class="stat-label">Pages Read</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="readingSpeed">0</div>
                    <div class="stat-label">Pages/Hour</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completion">0%</div>
                    <div class="stat-label">Completion</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8035';
    let currentBook = null;
    let currentPage = 1;
    let totalPages = 1;
    let startTime = new Date();
    let pagesRead = 0;

    // Initialize reader
    document.addEventListener('DOMContentLoaded', function() {
        initializeReader();
    });

    async function initializeReader() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');

        if (!bookId) {
            alert('No book specified!');
            window.close();
            return;
        }

        // ‚úÖ DEBUG CALL
        await debugFilePaths(bookId);

        // AI Health Check
        await checkAIHealth();

        await loadBookData(bookId);
        await loadAISummary(bookId);
        startReadingTimer();
    }

    // ‚úÖ DEBUG FUNCTION
    async function debugFilePaths(bookId) {
        try {
            console.log("üîç Starting file path debug for book ID:", bookId);

            const response = await fetch(`${API_BASE_URL}/book/apies/findById/${bookId}`);
            if (response.ok) {
                const book = await response.json();
                console.log("üîç FILE PATH DEBUG:");
                console.log("üìÅ File Path:", book.filePath);
                console.log("üìÑ File Name:", book.fileName);
                console.log("üî§ File Type:", book.fileType);
                console.log("üìñ Has Extracted Text:", book.extractedText ? 'Yes' : 'No');
                console.log("üìö Book Title:", book.title);
                console.log("üë§ Book Author:", book.author);

                // Test reader URLs
                const pdfUrl = `${API_BASE_URL}/reader/${bookId}`;
                const textUrl = `${API_BASE_URL}/reader/${bookId}?mode=text`;
                console.log("üîó PDF URL:", pdfUrl);
                console.log("üîó Text URL:", textUrl);

                // Test the reader URLs
                try {
                    const pdfResponse = await fetch(pdfUrl);
                    console.log("üì° PDF API Status:", pdfResponse.status);
                    console.log("üì° PDF API OK:", pdfResponse.ok);

                    const textResponse = await fetch(textUrl);
                    console.log("üì° Text API Status:", textResponse.status);
                    console.log("üì° Text API OK:", textResponse.ok);

                } catch (fetchError) {
                    console.error("‚ùå Fetch error:", fetchError);
                }

            } else {
                console.error("‚ùå Failed to fetch book data:", response.status);
            }
        } catch (error) {
            console.error("‚ùå Debug error:", error);
        }
    }

    async function loadBookData(bookId) {
        try {
            console.log("üìö Loading book data for ID: " + bookId);

            // Pehle book info get karo
            const infoResponse = await fetch(`${API_BASE_URL}/reader/${bookId}/info`);
            if (!infoResponse.ok) {
                throw new Error('Failed to load book info');
            }

            const bookInfo = await infoResponse.json();
            currentBook = bookInfo;

            // Update UI
            document.getElementById('bookTitle').textContent = currentBook.title;
            document.getElementById('bookInfo').innerHTML = `
                <p><strong>Author:</strong> ${currentBook.author}</p>
                <p><strong>Language:</strong> ${currentBook.language || 'English'}</p>
                <p><strong>Format:</strong> ${currentBook.fileType || 'PDF'}</p>
                ${currentBook.description ? `<p><strong>Description:</strong> ${currentBook.description.substring(0, 150)}...</p>` : ''}
            `;

            // ‚úÖ IMPROVED: Try PDF first, then fallback to text
            await tryLoadPDF(bookId);

            // Simulate page count
            totalPages = Math.floor(Math.random() * 200) + 50;
            updatePageInfo();

            console.log("‚úÖ Book data loaded successfully");

        } catch (error) {
            console.error('‚ùå Error loading book:', error);
            document.getElementById('bookInfo').innerHTML =
                '<p style="color: red;">Error loading book information: ' + error.message + '</p>';

            // ‚úÖ Fallback: Try text mode directly
            await tryLoadTextContent(bookId);
        }
    }

    // ‚úÖ NEW: PDF loading with better error handling
    async function tryLoadPDF(bookId) {
        try {
            const pdfUrl = `${API_BASE_URL}/reader/${bookId}`;
            console.log("üîó Attempting to load PDF from: " + pdfUrl);

            const pdfResponse = await fetch(pdfUrl);
            if (!pdfResponse.ok) {
                throw new Error(`PDF fetch failed: ${pdfResponse.status}`);
            }

            const pdfBlob = await pdfResponse.blob();

            if (pdfBlob.size === 0) {
                throw new Error('PDF blob is empty');
            }

            const blobUrl = URL.createObjectURL(pdfBlob);
            document.getElementById('pdfFrame').src = blobUrl;
            console.log("‚úÖ PDF loaded successfully via blob URL");

        } catch (pdfError) {
            console.error("‚ùå PDF loading failed:", pdfError);
            throw pdfError; // Re-throw to trigger text fallback
        }
    }

    // ‚úÖ NEW: Text content loading
    async function tryLoadTextContent(bookId) {
        try {
            console.log("üîÑ Falling back to text mode...");
            const textResponse = await fetch(`${API_BASE_URL}/reader/${bookId}?mode=text`);

            if (textResponse.ok) {
                const textData = await textResponse.json();
                showTextContent(textData.content);
                console.log("‚úÖ Text content loaded successfully");
            } else {
                throw new Error('Text mode also failed');
            }
        } catch (textError) {
            console.error("‚ùå Text mode failed:", textError);
            showErrorContent();
        }
    }

    // ‚úÖ NEW: Show text content
    function showTextContent(content) {
        const pdfViewer = document.querySelector('.pdf-viewer');
        pdfViewer.innerHTML = `
            <div style="padding: 30px; height: 100%; overflow-y: auto; background: white; font-family: Arial, sans-serif;">
                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #667eea;">
                    <h2 style="color: #333; margin-bottom: 10px;">${currentBook.title}</h2>
                    <h4 style="color: #666; margin-bottom: 20px;">by ${currentBook.author}</h4>
                </div>
                <div style="line-height: 1.8; color: #444; font-size: 16px; white-space: pre-wrap; max-width: 800px; margin: 0 auto;">
                    ${content || 'No text content available for this book.'}
                </div>
            </div>
        `;

        // Hide PDF controls
        document.querySelector('.pdf-controls').style.display = 'none';
    }

    // ‚úÖ NEW: Show error content
    function showErrorContent() {
        const pdfViewer = document.querySelector('.pdf-viewer');
        pdfViewer.innerHTML = `
            <div style="padding: 50px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white;">
                <div style="font-size: 4rem; color: #ff6b6b; margin-bottom: 20px;">‚ùå</div>
                <h3 style="color: #333; margin-bottom: 15px;">Unable to Load Book Content</h3>
                <p style="color: #666; margin-bottom: 25px; max-width: 500px;">
                    We're unable to load the book content at the moment. This could be due to file format issues or server problems.
                </p>
                <button onclick="location.reload()" class="read-more" style="background: #667eea;">
                    üîÑ Try Again
                </button>
            </div>
        `;

        document.querySelector('.pdf-controls').style.display = 'none';
    }

    async function loadAISummary(bookId) {
        try {
            const response = await fetch(`${API_BASE_URL}/ai/summary/book/${bookId}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('chapterSummary').innerHTML = `
                    <div class="chapter-summary">
                        <p>${data.summary.summary}</p>
                    </div>
                `;

                // Update key points
                const keyPointsHtml = data.summary.keyPoints.map(point =>
                    `<li>${point}</li>`
                ).join('');
                document.getElementById('keyPoints').innerHTML = keyPointsHtml;

            } else {
                throw new Error('Failed to load AI summary');
            }
        } catch (error) {
            console.error('Error loading AI summary:', error);
            // Fallback to mock data
            loadMockAIData();
        }
    }

    // Mock data fallback
    function loadMockAIData() {
        document.getElementById('chapterSummary').innerHTML = `
            <div class="chapter-summary">
                <p>This book explores important themes and concepts relevant to the subject matter. The author presents insights and analysis that help readers understand the core ideas and their practical applications.</p>
                <p>The content is structured to build understanding progressively, starting with fundamental concepts and moving towards more complex topics.</p>
            </div>
        `;

        document.getElementById('keyPoints').innerHTML = `
            <li>Comprehensive coverage of main topics</li>
            <li>Practical examples and case studies</li>
            <li>Step-by-step learning approach</li>
            <li>Real-world applications discussed</li>
            <li>Key insights and takeaways highlighted</li>
        `;
    }

    // AI Health Check
    async function checkAIHealth() {
        try {
            const response = await fetch(`${API_BASE_URL}/ai/health`);
            const health = await response.json();

            const aiStatusElement = document.getElementById('aiStatus');

            if (health.aiService === "AVAILABLE") {
                aiStatusElement.innerHTML = `
                    <span class="ai-online">
                        <i class='bx bx-chip'></i> AI Online
                    </span>
                `;
            } else {
                aiStatusElement.innerHTML = `
                    <span class="ai-demo">
                        <i class='bx bx-chip'></i> AI Demo Mode
                    </span>
                `;
            }

            console.log('AI Service Status:', health);
        } catch (error) {
            console.warn('AI service health check failed:', error);

            const aiStatusElement = document.getElementById('aiStatus');
            aiStatusElement.innerHTML = `
                <span class="ai-offline">
                    <i class='bx bx-error'></i> AI Offline
                </span>
            `;
        }
    }

    async function askAIQuestion() {
        const questionInput = document.getElementById('questionInput');
        const question = questionInput.value.trim();
        const answerDiv = document.getElementById('aiAnswer');

        if (!question) return;

        // Show loading state
        answerDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>AI is thinking...</div>';
        answerDiv.classList.add('show');

        try {
            const response = await fetch(`${API_BASE_URL}/ai/question/book/${getBookIdFromURL()}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    language: 'en'
                })
            });

            if (response.ok) {
                const data = await response.json();
                answerDiv.innerHTML = `
                    <p><strong>Q:</strong> ${question}</p>
                    <p><strong>A:</strong> ${data.answer.answer}</p>
                    ${data.answer.answeredFromContext ?
                        '<p><small>‚úì Answered from book context</small></p>' :
                        '<p><small>‚ö† General knowledge response</small></p>'}
                `;
                questionInput.value = '';
            } else {
                throw new Error('Failed to get AI answer');
            }
        } catch (error) {
            console.error('Error asking AI:', error);
            answerDiv.innerHTML = '<p>Sorry, I encountered an error. Please try again.</p>';
        }
    }

    function updatePageInfo() {
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;

        // Update completion percentage
        const completion = Math.round((currentPage / totalPages) * 100);
        document.getElementById('completion').textContent = `${completion}%`;
        document.getElementById('pagesRead').textContent = currentPage;
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updatePageInfo();
            pagesRead++;
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            updatePageInfo();
            pagesRead++;
        }
    }

    function startReadingTimer() {
        setInterval(() => {
            const now = new Date();
            const minutes = Math.floor((now - startTime) / 60000);
            document.getElementById('timeSpent').textContent = `${minutes}m`;

            // Calculate reading speed
            if (minutes > 0) {
                const pagesPerHour = Math.round((pagesRead / minutes) * 60);
                document.getElementById('readingSpeed').textContent = pagesPerHour;
            }
        }, 60000); // Update every minute
    }

    async function saveProgress() {
        const user = getCurrentUser();
        if (!user) {
            alert('Please log in to save your progress.');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/progress/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: user.id,
                    bookId: getBookIdFromURL(),
                    currentPage: currentPage,
                    totalPages: totalPages,
                    readingTimeMinutes: Math.floor((new Date() - startTime) / 60000)
                })
            });

            if (response.ok) {
                alert('Progress saved successfully!');
            } else {
                throw new Error('Failed to save progress');
            }
        } catch (error) {
            console.error('Error saving progress:', error);
            alert('Error saving progress');
        }
    }

    function closeReader() {
        if (confirm('Are you sure you want to close the reader? Your progress will be saved automatically.')) {
            saveProgress();
            window.close();
        }
    }

    function getBookIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('bookId');
    }

    function getCurrentUser() {
        try {
            const userData = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn');

            if (userData && isLoggedIn === 'true') {
                return JSON.parse(userData);
            }
            return null;
        } catch (error) {
            return null;
        }
    }

    // ‚úÖ PDF frame error handling
    document.getElementById('pdfFrame').addEventListener('load', function() {
        console.log("‚úÖ PDF frame loaded successfully");
    });

    document.getElementById('pdfFrame').addEventListener('error', function(e) {
        console.error("‚ùå PDF frame loading error:", e);

        // Auto fallback to text mode
        const bookId = getBookIdFromURL();
        tryLoadTextContent(bookId);
    });
</script>

</body>
</html>