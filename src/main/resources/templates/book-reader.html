<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - Intelli-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Chakra Petch", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .book-title {
            font-size: 1.3rem;
            color: #333;
            text-align: center;
            flex: 1;
        }

        .reader-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .reader-container {
            display: flex;
            height: calc(100vh - 70px);
            padding: 20px;
            gap: 20px;
        }

        .pdf-viewer {
            flex: 7;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pdf-frame-container {
            flex: 1;
            position: relative;
        }

        #pdfFrame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .pdf-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .ai-sidebar {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .ai-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .ai-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .ai-section h3 i {
            color: #667eea;
        }

        .chapter-summary {
            line-height: 1.6;
            color: #555;
            font-size: 0.95rem;
        }

        .key-points {
            list-style: none;
            margin-top: 10px;
        }

        .key-points li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-points li:before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .question-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #questionInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        #questionInput:focus {
            border-color: #667eea;
        }

        .ask-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .ask-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-answer {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
            display: none;
        }

        .ai-answer.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .reading-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* AI Status Indicator */
        .ai-status {
            margin-right: 15px;
        }

        .ai-status span {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ai-online {
            background: #28a745;
            color: white;
        }

        .ai-demo {
            background: #ffc107;
            color: #856404;
        }

        .ai-offline {
            background: #dc3545;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .reader-container {
                flex-direction: column;
                height: auto;
            }

            .pdf-viewer {
                height: 70vh;
            }

            .ai-sidebar {
                height: auto;
            }
        }

        /* Custom PDF viewer styling to hide controls */
        .pdf-viewer {
            position: relative;
        }

        /* Hide PDF toolbar and controls */
        .pdf-viewer iframe {
            pointer-events: auto;
        }

        /* Disable context menu on PDF */
        .pdf-viewer iframe {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Custom scrollbar for PDF viewer */
        .pdf-frame-container::-webkit-scrollbar {
            width: 8px;
        }

        .pdf-frame-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .pdf-frame-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .pdf-frame-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
<!-- Header -->
<div class="reader-header">
    <div class="logo">Intelli-Read</div>
    <div class="book-title" id="bookTitle">A Teacher's Lot</div>

    <!-- AI Status Indicator -->
    <div class="ai-status" id="aiStatus">
            <span class="ai-online">
                <i class='bx bx-chip'></i> AI Online
            </span>
    </div>

    <div class="reader-controls">
        <button class="control-btn" onclick="saveProgress()">
            <i class='bx bx-bookmark'></i> Save Progress
        </button>
        <button class="control-btn" onclick="closeReader()">
            <i class='bx bx-x'></i> Close
        </button>
    </div>
</div>

<!-- Main Reader Container -->
<div class="reader-container">
    <!-- PDF Viewer -->
    <div class="pdf-viewer">
        <div class="pdf-frame-container">
            <!-- PDF will be displayed here -->
            <div id="pdfContent" style="padding: 30px; height: 100%; overflow-y: auto; background: white; font-family: Arial, sans-serif;">
                <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #667eea;">
                    <h2 style="color: #333; margin-bottom: 10px;">A Teacher's Lot</h2>
                    <h4 style="color: #666; margin-bottom: 20px;">by Unknown Author</h4>
                </div>
                <div style="line-height: 1.8; color: #444; font-size: 16px; white-space: pre-wrap; max-width: 800px; margin: 0 auto;">
                    <p><strong>Which name was basically a 'Freezing Works Town,' and many of our school parents worked at the Mataura works so I thought it would be good to see where Daddy worked. All the class were bundled into cars and away we went. I actually thought we were going to see the secondary processes but that didn't happen. Our guide took us straight to the slaughtering area. A 'Judas' sheep with a metal collar ID had been trained to run up the chute and the other sheep would follow. Judas was let out a side door for a handful of sheep-nuts whilst the other poor creatures were tipped onto their backs and 'gaaawshhh!' (that's supposed to be a slashing noise) The demise of the cattle was a little more humane with a quick stun to the brain with a captive bolt pistol, before the cut and slash bit. If any ex-pupils read this, it may make you feel better to know I still occasionally have nightmares over the whole process.</strong></p>

                    <p>I considered it my duty to play rugby for the local Wyndham team and did so accordingly. Before our first match the coach said to me, "When their first-five gets the ball I want you to hit him so hard that he doesn't get up for the rest of the game." I thought wearing ties in Cheviot was serious enough, but training to become an assassin was a bit over the top. After three games I was the recipient of a broken nose, (not bleeding, broken and bleeding) two games later I was carted off to hospital to have my ear sewn back on. Was Mike Tyson living in Edendale? With our second daughter now well on the way it was time to hang.</p>

                    <p style="margin-top: 40px; text-align: center; color: #667eea; font-weight: bold;">12 / 45</p>
                    <p style="text-align: center; color: #28a745; font-weight: bold;">100%</p>
                </div>
            </div>
        </div>

        <!-- Simple page navigation (hidden as requested) -->
        <div class="pdf-controls" style="display: none;">
            <div class="page-nav">
                <button class="nav-btn" onclick="previousPage()" id="prevBtn">
                    <i class='bx bx-chevron-left'></i>
                </button>
                <span id="pageInfo">Page 12 of 45</span>
                <button class="nav-btn" onclick="nextPage()" id="nextBtn">
                    <i class='bx bx-chevron-right'></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Sidebar -->
    <div class="ai-sidebar">
        <!-- Book Info Section -->
        <div class="ai-section">
            <h3><i class='bx bx-book'></i> Book Information</h3>
            <div id="bookInfo">
                <p><strong>Author:</strong> Unknown Author</p>
                <p><strong>Language:</strong> English</p>
                <p><strong>Format:</strong> Text</p>
                <p><strong>Description:</strong> A personal narrative about teaching experiences and life in a small town with freezing works.</p>
            </div>
        </div>

        <!-- AI Summary Section -->
        <div class="ai-section">
            <h3><i class='bx bx-brain'></i> AI Chapter Summary</h3>
            <div id="chapterSummary">
                <div class="chapter-summary">
                    <p>The author recounts two significant experiences from their teaching career. First, they organized a field trip for their class to visit the local freezing works where many parents worked. The visit took an unexpected turn when the guide took them directly to the slaughtering area, where they witnessed the process of sheep and cattle being slaughtered. The author notes they still have nightmares about this experience.</p>
                    <p>Second, the author describes their brief rugby career with the local Wyndham team, where the coach encouraged aggressive play. After sustaining multiple injuries including a broken nose and a torn ear requiring hospital treatment, and with a second child on the way, the author decided to quit playing rugby.</p>
                </div>
            </div>
        </div>

        <!-- Key Points Section -->
        <div class="ai-section">
            <h3><i class='bx bx-star'></i> Key Points</h3>
            <ul class="key-points" id="keyPoints">
                <li>Field trip to freezing works revealed unexpected slaughter process</li>
                <li>Use of "Judas sheep" to lead other sheep to slaughter</li>
                <li>Author still has nightmares about the experience</li>
                <li>Brief rugby career with aggressive coaching style</li>
                <li>Sustained serious injuries including broken nose and torn ear</li>
                <li>Decision to quit rugby with second child on the way</li>
            </ul>
        </div>

        <!-- Q&A Section -->
        <div class="ai-section">
            <h3><i class='bx bx-message-rounded'></i> Ask AI Assistant</h3>
            <div class="question-input-container">
                <input type="text" id="questionInput" placeholder="Ask anything about this book...">
                <button class="ask-btn" onclick="askAIQuestion()">Ask</button>
            </div>
            <div class="ai-answer" id="aiAnswer">
                <!-- AI answers will appear here -->
            </div>
        </div>

        <!-- Reading Analytics -->
        <div class="ai-section">
            <h3><i class='bx bx-stats'></i> Reading Analytics</h3>
            <div class="reading-stats" id="readingStats">
                <div class="stat-item">
                    <div class="stat-value" id="timeSpent">12m</div>
                    <div class="stat-label">Time Spent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pagesRead">12</div>
                    <div class="stat-label">Pages Read</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="readingSpeed">60</div>
                    <div class="stat-label">Pages/Hour</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completion">27%</div>
                    <div class="stat-label">Completion</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8035';
    let currentBook = null;
    let currentPage = 12;
    let totalPages = 45;
    let startTime = new Date();
    let pagesRead = 12;

    // Initialize reader
    document.addEventListener('DOMContentLoaded', function() {
        initializeReader();
    });

    async function initializeReader() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');

        if (!bookId) {
            // Use mock data for demonstration
            loadMockData();
            return;
        }

        // AI Health Check
        await checkAIHealth();
        await loadBookData(bookId);
        await loadAISummary(bookId);
        startReadingTimer();
    }

    // Load mock data for demonstration
    function loadMockData() {
        console.log("üìö Loading mock book data for demonstration");

        // Set book info
        document.getElementById('bookTitle').textContent = "A Teacher's Lot";

        // Set reading stats
        document.getElementById('timeSpent').textContent = '12m';
        document.getElementById('pagesRead').textContent = '12';
        document.getElementById('readingSpeed').textContent = '60';
        document.getElementById('completion').textContent = '27%';

        // Start reading timer
        startReadingTimer();
    }

    async function loadBookData(bookId) {
        try {
            console.log("üìö Loading book data for ID: " + bookId);

            // First get book info
            const infoResponse = await fetch(`${API_BASE_URL}/reader/${bookId}/info`);
            if (!infoResponse.ok) {
                throw new Error('Failed to load book info');
            }

            const bookInfo = await infoResponse.json();
            currentBook = bookInfo;

            // Update UI
            document.getElementById('bookTitle').textContent = currentBook.title;
            document.getElementById('bookInfo').innerHTML = `
                <p><strong>Author:</strong> ${currentBook.author}</p>
                <p><strong>Language:</strong> ${currentBook.language || 'English'}</p>
                <p><strong>Format:</strong> ${currentBook.fileType || 'PDF'}</p>
                ${currentBook.description ? `<p><strong>Description:</strong> ${currentBook.description.substring(0, 150)}...</p>` : ''}
            `;

            // Try to load content
            await tryLoadContent(bookId);

            // Set page info
            updatePageInfo();

            console.log("‚úÖ Book data loaded successfully");

        } catch (error) {
            console.error('‚ùå Error loading book:', error);
            document.getElementById('bookInfo').innerHTML =
                '<p style="color: red;">Error loading book information: ' + error.message + '</p>';

            // Fallback to text mode
            await tryLoadTextContent(bookId);
        }
    }

    // Try to load content
    async function tryLoadContent(bookId) {
        try {
            // For PDF files
            if (currentBook.fileType && currentBook.fileType.toLowerCase() === 'pdf') {
                await tryLoadPDF(bookId);
            } else {
                // For text files or other formats
                await tryLoadTextContent(bookId);
            }
        } catch (error) {
            console.error("‚ùå Content loading failed:", error);
            showTextContent("Unable to load book content. Please try again later.");
        }
    }

    // Try to load PDF
    async function tryLoadPDF(bookId) {
        try {
            const pdfUrl = `${API_BASE_URL}/reader/${bookId}`;
            console.log("üîó Attempting to load PDF from: " + pdfUrl);

            const pdfResponse = await fetch(pdfUrl);
            if (!pdfResponse.ok) {
                throw new Error(`PDF fetch failed: ${pdfResponse.status}`);
            }

            const pdfBlob = await pdfResponse.blob();

            if (pdfBlob.size === 0) {
                throw new Error('PDF blob is empty');
            }

            const blobUrl = URL.createObjectURL(pdfBlob);

            // Create a more controlled PDF viewer without toolbar
            const pdfContainer = document.getElementById('pdfContent');
            pdfContainer.innerHTML = `
                <iframe src="${blobUrl}#toolbar=0&navpanes=0" width="100%" height="100%" style="border: none;"></iframe>
            `;

            console.log("‚úÖ PDF loaded successfully via blob URL");

        } catch (pdfError) {
            console.error("‚ùå PDF loading failed:", pdfError);
            throw pdfError;
        }
    }

    // Try to load text content
    async function tryLoadTextContent(bookId) {
        try {
            console.log("üîÑ Loading text content...");
            const textResponse = await fetch(`${API_BASE_URL}/reader/${bookId}?mode=text`);

            if (textResponse.ok) {
                const textData = await textResponse.json();
                showTextContent(textData.content);
                console.log("‚úÖ Text content loaded successfully");
            } else {
                throw new Error('Text mode also failed');
            }
        } catch (textError) {
            console.error("‚ùå Text mode failed:", textError);
            showErrorContent();
        }
    }

    // Show text content
    function showTextContent(content) {
        const pdfContainer = document.getElementById('pdfContent');
        pdfContainer.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #667eea;">
                <h2 style="color: #333; margin-bottom: 10px;">${currentBook ? currentBook.title : "A Teacher's Lot"}</h2>
                <h4 style="color: #666; margin-bottom: 20px;">by ${currentBook ? currentBook.author : "Unknown Author"}</h4>
            </div>
            <div style="line-height: 1.8; color: #444; font-size: 16px; white-space: pre-wrap; max-width: 800px; margin: 0 auto;">
                ${content || 'No text content available for this book.'}
            </div>
        `;
    }

    // Show error content
    function showErrorContent() {
        const pdfContainer = document.getElementById('pdfContent');
        pdfContainer.innerHTML = `
            <div style="padding: 50px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white;">
                <div style="font-size: 4rem; color: #ff6b6b; margin-bottom: 20px;">‚ùå</div>
                <h3 style="color: #333; margin-bottom: 15px;">Unable to Load Book Content</h3>
                <p style="color: #666; margin-bottom: 25px; max-width: 500px;">
                    We're unable to load the book content at the moment. This could be due to file format issues or server problems.
                </p>
                <button onclick="location.reload()" class="control-btn" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer;">
                    <i class='bx bx-refresh'></i> Try Again
                </button>
            </div>
        `;
    }

    async function loadAISummary(bookId) {
        try {
            const response = await fetch(`${API_BASE_URL}/ai/summary/book/${bookId}`);
            if (response.ok) {
                const data = await response.json();

                document.getElementById('chapterSummary').innerHTML = `
                    <div class="chapter-summary">
                        <p>${data.summary.summary}</p>
                    </div>
                `;

                // Update key points
                const keyPointsHtml = data.summary.keyPoints.map(point =>
                    `<li>${point}</li>`
                ).join('');
                document.getElementById('keyPoints').innerHTML = keyPointsHtml;

            } else {
                throw new Error('Failed to load AI summary');
            }
        } catch (error) {
            console.error('Error loading AI summary:', error);
            // Fallback to mock data
            loadMockAIData();
        }
    }

    // Mock data fallback
    function loadMockAIData() {
        document.getElementById('chapterSummary').innerHTML = `
            <div class="chapter-summary">
                <p>The author recounts two significant experiences from their teaching career. First, they organized a field trip for their class to visit the local freezing works where many parents worked. The visit took an unexpected turn when the guide took them directly to the slaughtering area, where they witnessed the process of sheep and cattle being slaughtered. The author notes they still have nightmares about this experience.</p>
                <p>Second, the author describes their brief rugby career with the local Wyndham team, where the coach encouraged aggressive play. After sustaining multiple injuries including a broken nose and a torn ear requiring hospital treatment, and with a second child on the way, the author decided to quit playing rugby.</p>
            </div>
        `;

        document.getElementById('keyPoints').innerHTML = `
            <li>Field trip to freezing works revealed unexpected slaughter process</li>
            <li>Use of "Judas sheep" to lead other sheep to slaughter</li>
            <li>Author still has nightmares about the experience</li>
            <li>Brief rugby career with aggressive coaching style</li>
            <li>Sustained serious injuries including broken nose and torn ear</li>
            <li>Decision to quit rugby with second child on the way</li>
        `;
    }

    // AI Health Check
    async function checkAIHealth() {
        try {
            const response = await fetch(`${API_BASE_URL}/ai/health`);
            const health = await response.json();

            const aiStatusElement = document.getElementById('aiStatus');

            if (health.aiService === "AVAILABLE") {
                aiStatusElement.innerHTML = `
                    <span class="ai-online">
                        <i class='bx bx-chip'></i> AI Online
                    </span>
                `;
            } else {
                aiStatusElement.innerHTML = `
                    <span class="ai-demo">
                        <i class='bx bx-chip'></i> AI Demo Mode
                    </span>
                `;
            }

            console.log('AI Service Status:', health);
        } catch (error) {
            console.warn('AI service health check failed:', error);

            const aiStatusElement = document.getElementById('aiStatus');
            aiStatusElement.innerHTML = `
                <span class="ai-offline">
                    <i class='bx bx-error'></i> AI Offline
                </span>
            `;
        }
    }

    async function askAIQuestion() {
        const questionInput = document.getElementById('questionInput');
        const question = questionInput.value.trim();
        const answerDiv = document.getElementById('aiAnswer');

        if (!question) return;

        // Show loading state
        answerDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>AI is thinking...</div>';
        answerDiv.classList.add('show');

        try {
            const response = await fetch(`${API_BASE_URL}/ai/question/book/${getBookIdFromURL()}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    language: 'en'
                })
            });

            if (response.ok) {
                const data = await response.json();
                answerDiv.innerHTML = `
                    <p><strong>Q:</strong> ${question}</p>
                    <p><strong>A:</strong> ${data.answer.answer}</p>
                    ${data.answer.answeredFromContext ?
                        '<p><small>‚úì Answered from book context</small></p>' :
                        '<p><small>‚ö† General knowledge response</small></p>'}
                `;
                questionInput.value = '';
            } else {
                throw new Error('Failed to get AI answer');
            }
        } catch (error) {
            console.error('Error asking AI:', error);
            answerDiv.innerHTML = '<p>Sorry, I encountered an error. Please try again.</p>';
        }
    }

    function updatePageInfo() {
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;

        // Update completion percentage
        const completion = Math.round((currentPage / totalPages) * 100);
        document.getElementById('completion').textContent = `${completion}%`;
        document.getElementById('pagesRead').textContent = currentPage;
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updatePageInfo();
            pagesRead++;
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            updatePageInfo();
            pagesRead++;
        }
    }

    function startReadingTimer() {
        setInterval(() => {
            const now = new Date();
            const minutes = Math.floor((now - startTime) / 60000);
            document.getElementById('timeSpent').textContent = `${minutes}m`;

            // Calculate reading speed
            if (minutes > 0) {
                const pagesPerHour = Math.round((pagesRead / minutes) * 60);
                document.getElementById('readingSpeed').textContent = pagesPerHour;
            }
        }, 60000); // Update every minute
    }

    async function saveProgress() {
        const user = getCurrentUser();
        if (!user) {
            alert('Please log in to save your progress.');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/progress/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: user.id,
                    bookId: getBookIdFromURL(),
                    currentPage: currentPage,
                    totalPages: totalPages,
                    readingTimeMinutes: Math.floor((new Date() - startTime) / 60000)
                })
            });

            if (response.ok) {
                alert('Progress saved successfully!');
            } else {
                throw new Error('Failed to save progress');
            }
        } catch (error) {
            console.error('Error saving progress:', error);
            alert('Error saving progress');
        }
    }

    function closeReader() {
        if (confirm('Are you sure you want to close the reader? Your progress will be saved automatically.')) {
            saveProgress();
            window.close();
        }
    }

    function getBookIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('bookId');
    }

    function getCurrentUser() {
        try {
            const userData = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn');

            if (userData && isLoggedIn === 'true') {
                return JSON.parse(userData);
            }
            return null;
        } catch (error) {
            return null;
        }
    }
</script>

</body>
</html>