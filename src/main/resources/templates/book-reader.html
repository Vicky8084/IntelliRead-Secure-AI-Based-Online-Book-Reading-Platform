<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading - Intelli-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Chakra Petch", sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .book-title {
            font-size: 1.3rem;
            color: #333;
            text-align: center;
            flex: 1;
        }

        .reader-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .reader-container {
            display: flex;
            height: calc(100vh - 70px);
            padding: 20px;
            gap: 20px;
        }

        .pdf-viewer {
            flex: 7;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .pdf-frame-container {
            flex: 1;
            position: relative;
            overflow-y: auto;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #pdfFrame {
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: auto;
        }

        .pdf-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .page-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .page-info {
            font-weight: 500;
            color: #333;
            min-width: 100px;
            text-align: center;
        }

        .progress-container {
            flex: 1;
            max-width: 200px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .ai-sidebar {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        .ai-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }

        .ai-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .ai-section h3 i {
            color: #667eea;
        }

        .chapter-summary {
            line-height: 1.6;
            color: #555;
            font-size: 0.95rem;
        }

        .key-points {
            list-style: none;
            margin-top: 10px;
        }

        .key-points li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-points li:before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .question-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #questionInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        #questionInput:focus {
            border-color: #667eea;
        }

        .ask-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .ask-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-answer {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
            display: none;
        }

        .ai-answer.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .reading-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .stat-trend {
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-status {
            margin-right: 15px;
        }

        .ai-status span {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ai-online {
            background: #28a745;
            color: white;
        }

        .ai-offline {
            background: #dc3545;
            color: white;
        }

        .progress-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .progress-notification.show {
            transform: translateX(0);
        }

        .pdf-frame-container::-webkit-scrollbar {
            width: 8px;
        }

        .pdf-frame-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .pdf-frame-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .pdf-frame-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .pdf-content {
            padding: 40px;
            line-height: 1.8;
            font-family: 'Georgia', serif;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
        }

        .pdf-content h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        .pdf-content h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
            font-size: 1.6rem;
        }

        .pdf-content p {
            margin-bottom: 20px;
            text-align: justify;
            font-size: 1.1rem;
        }

        .pdf-content .page-number {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
            color: #7f8c8d;
            font-style: italic;
        }

        .custom-text-container {
            margin-bottom: 15px;
        }

        .custom-text-label {
            font-weight: 500;
            color: #333;
            display: block;
            margin-bottom: 8px;
        }

        .custom-text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .custom-text-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .language-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 100%;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .summarize-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .summarize-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .summarize-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .book-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .book-action-btn {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .book-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 1024px) {
            .reader-container {
                flex-direction: column;
                height: auto;
            }

            .pdf-viewer {
                height: 70vh;
            }

            .ai-sidebar {
                height: auto;
            }

            .pdf-controls {
                flex-direction: column;
                gap: 10px;
            }

            .pdf-content {
                padding: 20px;
            }

            .pdf-content h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
<!-- Progress Notification -->
<div class="progress-notification" id="progressNotification">
    <i class='bx bx-check-circle' style="font-size: 1.5rem;"></i>
    <div>
        <strong>Progress Saved!</strong>
        <div style="font-size: 0.85rem;" id="notificationMessage">Your reading progress has been updated</div>
    </div>
</div>

<!-- Header -->
<div class="reader-header">
    <div class="logo">Intelli-Read</div>
    <div class="book-title" id="bookTitle">Loading Book...</div>

    <!-- AI Status Indicator -->
    <div class="ai-status" id="aiStatus">
            <span class="ai-online">
                <i class='bx bx-chip'></i> AI Online
            </span>
    </div>

    <div class="reader-controls">
        <button class="control-btn" onclick="saveProgress()">
            <i class='bx bx-bookmark'></i> Save Progress
        </button>
        <button class="control-btn" onclick="closeReader()">
            <i class='bx bx-x'></i> Close
        </button>
    </div>
</div>

<!-- Main Reader Container -->
<div class="reader-container">
    <!-- PDF Viewer -->
    <div class="pdf-viewer">
        <div class="pdf-frame-container" id="pdfContainer">
            <iframe id="pdfFrame" width="100%" height="100%"></iframe>
        </div>

        <!-- Pagination Controls -->
        <div class="pdf-controls">
            <div class="page-nav">
                <button class="nav-btn" onclick="previousPage()" id="prevBtn">
                    <i class='bx bx-chevron-left'></i>
                </button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="nav-btn" onclick="nextPage()" id="nextBtn">
                    <i class='bx bx-chevron-right'></i>
                </button>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 5px;">
                    <span id="progressText">0% Complete</span>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Sidebar -->
    <div class="ai-sidebar">
        <!-- Book Info Section -->
        <div class="ai-section">
            <h3><i class='bx bx-book'></i> Book Information</h3>
            <div id="bookInfo">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading book info...
                </div>
            </div>
        </div>

        <!-- AI Text Summary Section - IMPROVED -->
        <div class="ai-section">
            <h3><i class='bx bx-brain'></i> AI Text Summary</h3>

            <!-- Book Actions -->
            <div class="book-actions">
                <button class="book-action-btn" onclick="summarizeCurrentPage()">
                    <i class='bx bx-file'></i> Summarize Current Page
                </button>
                <button class="book-action-btn" onclick="summarizeEntireBook()">
                    <i class='bx bx-book'></i> Summarize Book
                </button>
            </div>

            <!-- Language Selection -->
            <div class="custom-text-container">
                <label class="custom-text-label">
                    <i class='bx bx-globe'></i> Summary Language:
                </label>
                <select id="summaryLanguage" class="language-select">
                    <option value="en">English</option>
                    <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                    <option value="sa">Sanskrit (‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§Æ‡•ç)</option>
                    <option value="ml">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                    <option value="te">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                    <option value="kn">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                </select>
            </div>

            <!-- Text Input -->
            <div class="custom-text-container">
                <label class="custom-text-label">
                    <i class='bx bx-edit'></i> Or enter custom text for summary:
                </label>
                <textarea
                        id="customTextInput"
                        class="custom-text-input"
                        placeholder="Paste any paragraph or text here to get AI summary in your preferred language..."
                ></textarea>
            </div>

            <!-- Summarize Button -->
            <button class="summarize-btn" onclick="generateCustomSummary()" id="summarizeBtn">
                <i class='bx bx-brain'></i> Generate Summary
            </button>

            <!-- Summary Result -->
            <div id="customSummaryResult" style="display: none; margin-top: 15px;">
                <div class="ai-answer show">
                    <h4 style="margin-bottom: 10px; color: #333;">AI Summary:</h4>
                    <div id="customSummaryText" class="chapter-summary">
                        <!-- Summary will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Points Section -->
        <div class="ai-section">
            <h3><i class='bx bx-star'></i> Key Points</h3>
            <ul class="key-points" id="keyPoints">
                <li>Enter text above to generate key points</li>
            </ul>
        </div>

        <!-- Q&A Section -->
        <div class="ai-section">
            <h3><i class='bx bx-message-rounded'></i> Ask AI Assistant</h3>
            <div class="question-input-container">
                <input type="text" id="questionInput" placeholder="Ask anything about this book..." onkeypress="handleQuestionKeyPress(event)">
                <button class="ask-btn" onclick="askAIQuestion()">Ask</button>
            </div>
            <div class="ai-answer" id="aiAnswer">
                <!-- AI answers will appear here -->
            </div>
        </div>

        <!-- Reading Analytics -->
        <div class="ai-section">
            <h3><i class='bx bx-stats'></i> Reading Analytics</h3>
            <div class="reading-stats" id="readingStats">
                <div class="stat-item">
                    <div class="stat-value" id="timeSpent">0m</div>
                    <div class="stat-label">Time Spent</div>
                    <div class="stat-trend trend-up" id="timeTrend"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pagesRead">0</div>
                    <div class="stat-label">Pages Read</div>
                    <div class="stat-trend trend-up" id="pagesTrend"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="readingSpeed">0</div>
                    <div class="stat-label">Pages/Hour</div>
                    <div class="stat-trend trend-up" id="speedTrend"></div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completion">0%</div>
                    <div class="stat-label">Completion</div>
                    <div class="stat-trend trend-up" id="completionTrend"></div>
                </div>
            </div>

            <!-- Additional Analytics -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 10px; color: #333;">Session Summary</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                    <div>
                        <strong>Session Start:</strong>
                        <span id="sessionStart">--:--</span>
                    </div>
                    <div>
                        <strong>Current Streak:</strong>
                        <span id="currentStreak">0 days</span>
                    </div>
                    <div>
                        <strong>Words Read:</strong>
                        <span id="wordsRead">0</span>
                    </div>
                    <div>
                        <strong>Avg Focus:</strong>
                        <span id="avgFocus">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // Configuration Constants
    // ============================================================
    const API_BASE_URL = 'http://localhost:8035';

    // ‚úÖ Google Gemini Configuration - CORRECT MODEL
    const GEMINI_API_KEY = 'AIzaSyAFTwcSCsEDsqpZBhrTaah9iBQPDuoTuu8';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent';

    // Application State
    let currentBook = null;
    let currentPage = 1;
    let totalPages = 1;
    let startTime = new Date();
    let pagesRead = 0;
    let totalReadingTime = 0;
    let autoSaveInterval;
    let sessionWordsRead = 0;
    let readingStreak = 0;
    let bookTextContent = '';

    // ============================================================
    // Initialization
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
        initializeReader();
    });

    async function initializeReader() {
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');

        if (!bookId) {
            alert('No book specified!');
            return;
        }

        // Debug file paths
        await debugFilePaths(bookId);

        // AI Health Check
        await checkAIHealth();

        await loadBookData(bookId);
        startReadingTimer();
        startAutoSave();
        updateSessionStartTime();
    }

    // ============================================================
    // Book Loading Functions
    // ============================================================
    async function debugFilePaths(bookId) {
        try {
            console.log("üîç Starting file path debug for book ID:", bookId);
            const response = await fetch(`${API_BASE_URL}/book/apies/findById/${bookId}`);
            if (response.ok) {
                const book = await response.json();
                console.log("üîç FILE PATH DEBUG:");
                console.log("üìÅ File Path:", book.filePath);
                console.log("üìÑ File Name:", book.fileName);
                console.log("üî§ File Type:", book.fileType);
                console.log("üìñ Has Extracted Text:", book.extractedText ? 'Yes' : 'No');
                console.log("üìö Book Title:", book.title);
                console.log("üë§ Book Author:", book.author);

                // Load extracted text if available
                if (book.extractedText) {
                    bookTextContent = book.extractedText;
                    console.log("üìù Extracted text loaded:", bookTextContent.length, "characters");
                }
            }
        } catch (error) {
            console.error("‚ùå Debug error:", error);
        }
    }

    async function loadBookData(bookId) {
        try {
            console.log("üìö Loading book data for ID: " + bookId);
            const infoResponse = await fetch(`${API_BASE_URL}/reader/${bookId}/info`);
            if (!infoResponse.ok) {
                throw new Error('Failed to load book info');
            }

            const bookInfo = await infoResponse.json();
            currentBook = bookInfo;

            // Update UI with book information
            document.getElementById('bookTitle').textContent = currentBook.title;
            document.getElementById('bookInfo').innerHTML = `
                <p><strong>Author:</strong> ${currentBook.author}</p>
                <p><strong>Language:</strong> ${currentBook.language || 'English'}</p>
                <p><strong>Format:</strong> ${currentBook.fileType || 'PDF'}</p>
                ${currentBook.description ? `<p><strong>Description:</strong> ${currentBook.description.substring(0, 150)}...</p>` : ''}
            `;

            // Load previous progress
            await loadPreviousProgress(bookId);

            // Try to load PDF first, then fallback to text
            await tryLoadPDF(bookId);

            console.log("‚úÖ Book data loaded successfully");

        } catch (error) {
            console.error('‚ùå Error loading book:', error);
            document.getElementById('bookInfo').innerHTML =
                '<p style="color: red;">Error loading book information: ' + error.message + '</p>';
            await tryLoadTextContent(bookId);
        }
    }

    async function loadPreviousProgress(bookId) {
        try {
            const user = getCurrentUser();
            if (!user) return;

            const response = await fetch(`${API_BASE_URL}/progress/user/${user.id}/book/${bookId}`);
            if (response.ok) {
                const progress = await response.json();
                if (progress.currentPage) {
                    currentPage = progress.currentPage;
                    totalPages = progress.totalPages;
                    totalReadingTime = progress.readingTimeMinutes || 0;
                    updatePageInfo();
                    showNotification(`Resumed from page ${currentPage}`, 'info');
                }
            }
        } catch (error) {
            console.log('No previous progress found or error loading progress');
        }
    }

    async function tryLoadPDF(bookId) {
        try {
            const pdfUrl = `${API_BASE_URL}/reader/${bookId}`;
            console.log("üîó Attempting to load PDF from: " + pdfUrl);

            const pdfResponse = await fetch(pdfUrl);
            if (!pdfResponse.ok) {
                throw new Error(`PDF fetch failed: ${pdfResponse.status}`);
            }

            const pdfBlob = await pdfResponse.blob();
            if (pdfBlob.size === 0) {
                throw new Error('PDF blob is empty');
            }

            const blobUrl = URL.createObjectURL(pdfBlob);
            document.getElementById('pdfFrame').src = blobUrl + '#toolbar=0&navpanes=0&scrollbar=0';
            console.log("‚úÖ PDF loaded successfully via blob URL");

            totalPages = 45; // This should come from PDF metadata or book info
            updatePageInfo();

        } catch (pdfError) {
            console.error("‚ùå PDF loading failed:", pdfError);
            throw pdfError;
        }
    }

    async function tryLoadTextContent(bookId) {
        try {
            console.log("üîÑ Falling back to text mode...");
            const textResponse = await fetch(`${API_BASE_URL}/reader/${bookId}?mode=text`);
            if (textResponse.ok) {
                const textData = await textResponse.json();
                bookTextContent = textData.content;
                showTextContent(textData.content);
                console.log("‚úÖ Text content loaded successfully");
            } else {
                throw new Error('Text mode also failed');
            }
        } catch (textError) {
            console.error("‚ùå Text mode failed:", textError);
            showErrorContent();
        }
    }

    function showTextContent(content) {
        const pdfContainer = document.getElementById('pdfContainer');
        pdfContainer.innerHTML = `
            <div class="pdf-content">
                <h1>${currentBook.title}</h1>
                <h4 style="text-align: center; color: #666; margin-bottom: 30px;">by ${currentBook.author}</h4>
                <div style="line-height: 1.8; color: #444; white-space: pre-wrap;">
                    ${content || 'No text content available for this book.'}
                </div>
                <div class="page-number">Page ${currentPage} of ${totalPages}</div>
            </div>
        `;
        document.querySelector('.pdf-controls').style.display = 'none';
    }

    function showErrorContent() {
        const pdfContainer = document.getElementById('pdfContainer');
        pdfContainer.innerHTML = `
            <div style="padding: 50px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white;">
                <div style="font-size: 4rem; color: #ff6b6b; margin-bottom: 20px;">‚ùå</div>
                <h3 style="color: #333; margin-bottom: 15px;">Unable to Load Book Content</h3>
                <p style="color: #666; margin-bottom: 25px; max-width: 500px;">
                    We're unable to load the book content at the moment. This could be due to file format issues or server problems.
                </p>
                <button onclick="location.reload()" class="control-btn" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer;">
                    <i class='bx bx-refresh'></i> Try Again
                </button>
            </div>
        `;
        document.querySelector('.pdf-controls').style.display = 'none';
    }

    // ============================================================
    // NEW: Book Text Summary Functions
    // ============================================================
    async function summarizeCurrentPage() {
        if (!bookTextContent) {
            showNotification('No book text content available. Please load the book first.', 'warning');
            return;
        }

        // For now, we'll use the entire text since we don't have page-wise text
        await generateBookSummary(bookTextContent, 'current page');
    }

    async function summarizeEntireBook() {
        if (!bookTextContent) {
            showNotification('No book text content available. Please load the book first.', 'warning');
            return;
        }

        await generateBookSummary(bookTextContent, 'entire book');
    }

    async function generateBookSummary(text, context) {
        const languageSelect = document.getElementById('summaryLanguage');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const resultDiv = document.getElementById('customSummaryResult');
        const summaryText = document.getElementById('customSummaryText');
        const keyPointsList = document.getElementById('keyPoints');

        const language = languageSelect.value;

        // Show loading state
        summarizeBtn.innerHTML = '<i class="bx bx-loader-circle bx-spin"></i> Generating...';
        summarizeBtn.disabled = true;
        resultDiv.style.display = 'none';

        try {
            // Use Gemini to generate summary
            const result = await generateGeminiSummaryForText(text, language, context);

            // Display summary
            summaryText.innerHTML = `<p><strong>Summary of ${context}:</strong></p><p>${result.summary}</p>`;
            resultDiv.style.display = 'block';

            // Update key points
            const keyPointsHtml = result.keyPoints.map(point =>
                `<li>${point}</li>`
            ).join('');
            keyPointsList.innerHTML = keyPointsHtml;

            showNotification(`${context} summary generated successfully!`, 'success');

        } catch (error) {
            console.error('Error generating summary:', error);
            showNotification('Failed to generate summary. Please try again.', 'error');
        } finally {
            // Reset button
            summarizeBtn.innerHTML = '<i class="bx bx-brain"></i> Generate Summary';
            summarizeBtn.disabled = false;
        }
    }

    // ============================================================
    // Pagination & Progress Functions
    // ============================================================
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            pagesRead++;
            updatePageInfo();
            updateAnalytics();
            autoSaveProgress();
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            pagesRead++;
            updatePageInfo();
            updateAnalytics();
            if (currentPage === totalPages) {
                showNotification('Book completed! Congratulations!', 'success');
                updateReadingStreak();
            }
            autoSaveProgress();
        }
    }

    function updatePageInfo() {
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        const completion = Math.round((currentPage / totalPages) * 100);
        document.getElementById('progressText').textContent = `${completion}% Complete`;
        document.getElementById('progressFill').style.width = `${completion}%`;
        document.getElementById('completion').textContent = `${completion}%`;
    }

    function updateAnalytics() {
        const now = new Date();
        const minutes = Math.floor((now - startTime) / 60000);
        document.getElementById('timeSpent').textContent = `${totalReadingTime + minutes}m`;
        document.getElementById('pagesRead').textContent = currentPage;

        if (minutes > 0) {
            const pagesPerHour = Math.round((pagesRead / minutes) * 60);
            document.getElementById('readingSpeed').textContent = pagesPerHour;
        }

        sessionWordsRead = currentPage * 250;
        document.getElementById('wordsRead').textContent = sessionWordsRead.toLocaleString();
        updateTrends();
    }

    function updateTrends() {
        const trends = document.querySelectorAll('.stat-trend');
        trends.forEach(trend => {
            const randomChange = Math.random() > 0.3 ? '+' + Math.floor(Math.random() * 10) : '-' + Math.floor(Math.random() * 5);
            trend.textContent = randomChange + ' from avg';
            trend.className = 'stat-trend ' + (randomChange.startsWith('+') ? 'trend-up' : 'trend-down');
        });
    }

    function startAutoSave() {
        autoSaveInterval = setInterval(() => {
            autoSaveProgress();
        }, 30000);
    }

    function autoSaveProgress() {
        const user = getCurrentUser();
        if (!user) return;
        const now = new Date();
        const additionalMinutes = Math.floor((now - startTime) / 60000);
        totalReadingTime += additionalMinutes;
        startTime = now;
        saveProgressToServer(false);
    }

    async function saveProgress() {
        const result = await saveProgressToServer(true);
        if (result) {
            showNotification('Progress saved successfully!', 'success');
        }
    }

    async function saveProgressToServer(showNotification = true) {
        const user = getCurrentUser();
        if (!user) {
            if (showNotification) {
                showNotification('Please log in to save your progress.', 'warning');
            }
            return false;
        }

        try {
            const now = new Date();
            const additionalMinutes = Math.floor((now - startTime) / 60000);
            totalReadingTime += additionalMinutes;
            startTime = now;

            const response = await fetch(`${API_BASE_URL}/progress/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: user.id,
                    bookId: getBookIdFromURL(),
                    currentPage: currentPage,
                    totalPages: totalPages,
                    readingTimeMinutes: totalReadingTime
                })
            });

            if (response.ok) {
                console.log('‚úÖ Progress saved successfully');
                return true;
            } else {
                throw new Error('Failed to save progress');
            }
        } catch (error) {
            console.error('Error saving progress:', error);
            if (showNotification) {
                showNotification('Error saving progress', 'error');
            }
            return false;
        }
    }

    function updateReadingStreak() {
        const lastReadDate = localStorage.getItem('lastReadDate');
        const today = new Date().toDateString();
        if (lastReadDate !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastReadDate === yesterday.toDateString()) {
                readingStreak++;
            } else {
                readingStreak = 1;
            }
            localStorage.setItem('lastReadDate', today);
            localStorage.setItem('readingStreak', readingStreak.toString());
            document.getElementById('currentStreak').textContent = `${readingStreak} days`;
        }
    }

    // ============================================================
    // AI Functions - GOOGLE GEMINI INTEGRATION
    // ============================================================
    async function checkAIHealth() {
        try {
            const aiStatusElement = document.getElementById('aiStatus');

            // Fixed API key check
            if (GEMINI_API_KEY && GEMINI_API_KEY.length > 30) {
                aiStatusElement.innerHTML = `
                    <span class="ai-online">
                        <i class='bx bx-chip'></i> Google Gemini Online
                    </span>
                `;
                console.log('‚úÖ Google Gemini Service: ONLINE');
            } else {
                aiStatusElement.innerHTML = `
                    <span class="ai-offline">
                        <i class='bx bx-error'></i> AI Offline
                    </span>
                `;
                console.log('‚ùå AI Service: OFFLINE (Add Gemini API Key)');
            }
        } catch (error) {
            console.warn('AI service health check failed:', error);
            const aiStatusElement = document.getElementById('aiStatus');
            aiStatusElement.innerHTML = `
                <span class="ai-offline">
                    <i class='bx bx-error'></i> AI Offline
                </span>
            `;
        }
    }

    // ============================================================
    // Custom Text Summary Function
    // ============================================================
    async function generateCustomSummary() {
        const textInput = document.getElementById('customTextInput');
        const languageSelect = document.getElementById('summaryLanguage');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const resultDiv = document.getElementById('customSummaryResult');
        const summaryText = document.getElementById('customSummaryText');
        const keyPointsList = document.getElementById('keyPoints');

        const text = textInput.value.trim();
        const language = languageSelect.value;

        if (!text) {
            showNotification('Please enter some text to summarize', 'warning');
            return;
        }

        // Show loading state
        summarizeBtn.innerHTML = '<i class="bx bx-loader-circle bx-spin"></i> Generating...';
        summarizeBtn.disabled = true;
        resultDiv.style.display = 'none';

        try {
            // Use Gemini to generate summary
            const result = await generateGeminiSummaryForText(text, language);

            // Display summary
            summaryText.innerHTML = `<p>${result.summary}</p>`;
            resultDiv.style.display = 'block';

            // Update key points
            const keyPointsHtml = result.keyPoints.map(point =>
                `<li>${point}</li>`
            ).join('');
            keyPointsList.innerHTML = keyPointsHtml;

            showNotification('Summary generated successfully!', 'success');

        } catch (error) {
            console.error('Error generating summary:', error);
            showNotification('Failed to generate summary. Please try again.', 'error');
        } finally {
            // Reset button
            summarizeBtn.innerHTML = '<i class="bx bx-brain"></i> Generate Summary';
            summarizeBtn.disabled = false;
        }
    }

    // ============================================================
    // Gemini API Functions - FIXED MODEL
    // ============================================================
    async function generateGeminiSummaryForText(text, language, context = 'text') {
        // If no API key, return error
        if (!GEMINI_API_KEY || GEMINI_API_KEY.length <= 30) {
            throw new Error('AI service is currently unavailable. Please check your API key configuration.');
        }

        try {
            const languageNames = {
                'en': 'English',
                'hi': 'Hindi',
                'sa': 'Sanskrit',
                'ml': 'Malayalam',
                'te': 'Telugu',
                'kn': 'Kannada'
            };

            const prompt = `
Please analyze the following ${context} and provide:

1. A comprehensive summary in ${languageNames[language]} (3-4 paragraphs)
2. 5 key main points from the ${context}

${context} to analyze:
${text.substring(0, 3000)} ${text.length > 3000 ? '... [text truncated]' : ''}

Please format your response as:
SUMMARY: [your summary here]
KEY POINTS:
1. [first key point]
2. [second key point]
3. [third key point]
4. [fourth key point]
5. [fifth key point]
            `.trim();

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 1000,
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Gemini API error details:', errorText);
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();

            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response format from Gemini API');
            }

            const content = data.candidates[0].content.parts[0].text;

            return parseGeminiResponse(content);

        } catch (error) {
            console.error('Gemini API error:', error);
            throw new Error('Failed to generate summary. Please try again later.');
        }
    }

    function parseGeminiResponse(content) {
        // Parse the response to extract summary and key points
        const lines = content.split('\n');
        let summary = '';
        const keyPoints = [];
        let inSummary = false;
        let inKeyPoints = false;

        for (const line of lines) {
            const trimmedLine = line.trim();

            if (trimmedLine.startsWith('SUMMARY:')) {
                inSummary = true;
                inKeyPoints = false;
                summary += trimmedLine.replace('SUMMARY:', '').trim();
            } else if (trimmedLine.startsWith('KEY POINTS:')) {
                inSummary = false;
                inKeyPoints = true;
            } else if (inSummary && trimmedLine && !trimmedLine.match(/^\d+\./)) {
                summary += ' ' + trimmedLine;
            } else if (inKeyPoints && trimmedLine.match(/^\d+\./)) {
                const point = trimmedLine.replace(/^\d+\.\s*/, '').trim();
                if (point) keyPoints.push(point);
            }
        }

        // Fallback if parsing fails
        if (!summary) {
            const sentences = content.split('. ').filter(s => s.length > 10);
            summary = sentences.slice(0, 3).join('. ') + '.';
        }

        if (keyPoints.length === 0) {
            const sentences = content.split('. ').filter(s => s.length > 20);
            keyPoints.push(...sentences.slice(0, 5).map(s => s.substring(0, 100) + '...'));
        }

        return {
            summary: summary || 'Unable to generate summary for this text.',
            keyPoints: keyPoints.length > 0 ? keyPoints : [
                'Main ideas and concepts',
                'Key arguments presented',
                'Important evidence or examples',
                'Central themes discussed',
                'Conclusions or recommendations'
            ]
        };
    }

    // ============================================================
    // AI Q&A Function - Gemini Version
    // ============================================================
    async function askAIQuestion() {
        const questionInput = document.getElementById('questionInput');
        const question = questionInput.value.trim();
        const answerDiv = document.getElementById('aiAnswer');

        if (!question) return;

        // Show loading state
        answerDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>AI is thinking...</div>';
        answerDiv.classList.add('show');

        try {
            const book = currentBook;
            if (!book) {
                throw new Error('Book not loaded');
            }

            // Prepare context for the question
            const context = `
Book: "${book.title}" by ${book.author}
Description: ${book.description || 'No description available'}
Current Page: ${currentPage} of ${totalPages}
            `.trim();

            // Use Gemini to answer the question
            const answer = await generateGeminiAnswer(question, context, book);

            answerDiv.innerHTML = `
                <p><strong>Q:</strong> ${question}</p>
                <p><strong>A:</strong> ${answer}</p>
                <p><small>‚úì Answered using Google Gemini AI</small></p>
            `;
            questionInput.value = '';

        } catch (error) {
            console.error('Error asking AI:', error);
            answerDiv.innerHTML = `
                <p><strong>Q:</strong> ${question}</p>
                <p><strong>A:</strong> Sorry, I encountered an error while processing your question. Please try again.</p>
                <p><small>‚ùå Error: ${error.message}</small></p>
            `;
        }
    }

    async function generateGeminiAnswer(question, context, book) {
        // If no API key, return error
        if (!GEMINI_API_KEY || GEMINI_API_KEY.length <= 30) {
            throw new Error('AI service is currently unavailable. Please check your API key configuration.');
        }

        try {
            const prompt = `
Context about the book:
${context}

User's Question: ${question}

Please provide a helpful, accurate answer based on the book context. If the question is about specific content that isn't in the context, kindly explain what you can based on the available information.

Answer in a clear, conversational tone.
            `.trim();

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 500,
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gemini API error: ${response.status}`);
            }

            const data = await response.json();

            if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('Invalid response format from Gemini API');
            }

            return data.candidates[0].content.parts[0].text.trim();

        } catch (error) {
            console.error('Gemini Q&A error:', error);
            throw new Error('Failed to generate answer. Please try again later.');
        }
    }

    // ============================================================
    // Utility Functions
    // ============================================================
    function handleQuestionKeyPress(event) {
        if (event.key === 'Enter') {
            askAIQuestion();
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.getElementById('progressNotification');
        const messageElement = document.getElementById('notificationMessage');
        messageElement.textContent = message;

        if (type === 'success') {
            notification.style.background = '#28a745';
        } else if (type === 'error') {
            notification.style.background = '#dc3545';
        } else if (type === 'warning') {
            notification.style.background = '#ffc107';
            notification.style.color = '#856404';
        } else {
            notification.style.background = '#667eea';
        }

        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function updateSessionStartTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('sessionStart').textContent = timeString;
        const savedStreak = localStorage.getItem('readingStreak');
        if (savedStreak) {
            readingStreak = parseInt(savedStreak);
            document.getElementById('currentStreak').textContent = `${readingStreak} days`;
        }
        document.getElementById('avgFocus').textContent = '85%';
    }

    function startReadingTimer() {
        setInterval(() => {
            updateAnalytics();
        }, 60000);
    }

    function closeReader() {
        saveProgressToServer(false);
        if (confirm('Are you sure you want to close the reader? Your progress has been saved.')) {
            window.close();
        }
    }

    function getBookIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('bookId');
    }

    function getCurrentUser() {
        try {
            const userData = localStorage.getItem('user');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (userData && isLoggedIn === 'true') {
                return JSON.parse(userData);
            }
            return null;
        } catch (error) {
            return null;
        }
    }

    // PDF frame error handling
    document.getElementById('pdfFrame').addEventListener('load', function() {
        console.log("‚úÖ PDF frame loaded successfully");
    });

    document.getElementById('pdfFrame').addEventListener('error', function(e) {
        console.error("‚ùå PDF frame loading error:", e);
        const bookId = getBookIdFromURL();
        tryLoadTextContent(bookId);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        saveProgressToServer(false);
        clearInterval(autoSaveInterval);
    });
</script>

</body>
</html>